<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>skeleton log ¬∑ rescue mode</title>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background: #f5f5f7; color: #1d1d1f; padding: 20px; max-width: 500px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h1 { margin-bottom: 10px; }
        .btn { background: #007aff; color: white; border: none; padding: 12px 20px; border-radius: 12px; font-size: 16px; font-weight: 500; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn-outline { background: white; color: #007aff; border: 2px solid #007aff; }
        .found-item { background: #f0f7ff; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #007aff; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="recoveryScreen" class="card" style="border: 2px solid #34c759;">
        <h1>üöë Data Rescue</h1>
        <p style="color:#666; margin-bottom:20px;">Scanning your browser for lost data...</p>
        <div id="scanResults"></div>
    </div>

    <div id="app" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h1 style="margin:0;">skeleton</h1>
            <div>
                <button onclick="renderView('history')" style="font-size:24px; background:none; border:none; cursor:pointer;">üìÖ</button>
                <button onclick="renderView('settings')" style="font-size:24px; background:none; border:none; cursor:pointer;">‚öôÔ∏è</button>
            </div>
        </div>

        <div id="chips" style="display:flex; gap:10px; overflow-x:auto; padding-bottom:15px; margin-bottom:10px;"></div>

        <div class="card" id="mainCard">
            <div id="welcomeView">
                <div style="font-size:64px; text-align:center; margin-bottom:20px;">ü¶¥</div>
                <div id="contextList" style="display:flex; flex-direction:column; gap:10px;"></div>
            </div>

            <div id="loggerView" class="hidden">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px; color:#86868b;">
                    <span id="logCtxName">Context</span>
                    <span id="logStep">1/5</span>
                </div>
                <h2 id="qText" style="text-align:center; margin-bottom:30px; min-height:60px;">Question</h2>
                <div id="inputArea" style="margin-bottom:30px;"></div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-outline" onclick="prevQ()">‚Üê</button>
                    <button class="btn" onclick="nextQ()">Next ‚Üí</button>
                </div>
            </div>
        </div>
        
        <div id="settingsView" class="card hidden">
            <h2>Settings</h2>
            <p>If you see your data, please <b>Export Backup</b> immediately.</p>
            <button class="btn" style="background:#34c759;" onclick="exportData()">üì§ Export Backup File</button>
            <button class="btn btn-outline" onclick="renderView('welcome')">Close</button>
        </div>
        
        <div id="historyView" class="card hidden">
            <h2>History</h2>
            <div id="historyList"></div>
            <button class="btn btn-outline" onclick="renderView('welcome')">Close</button>
        </div>
    </div>

<script>
    // --- 1. RECOVERY LOGIC ---
    // We explicitly look for ALL versions we might have used
    const KNOWN_VERSIONS = ['v3', 'v4', 'v5', 'v6'];
    let currentData = { contexts: [], bank: [], assignments: {}, history: {} };
    
    // Default structure if nothing is found
    const DEFAULTS = {
        contexts: [{id:'morn', l:'Morning', i:'üåÖ', order:0}],
        bank: [{id:'q1', l:'Sleep?', t:'range', d:'5'}],
        assignments: {'morn':['q1']},
        history: {}
    };

    window.onload = function() {
        scanForData();
    };

    function scanForData() {
        const resultsDiv = document.getElementById('scanResults');
        let foundAny = false;

        KNOWN_VERSIONS.forEach(ver => {
            const ctxRaw = localStorage.getItem(`sk_ctx_${ver}`);
            if (ctxRaw) {
                foundAny = true;
                const ctxs = JSON.parse(ctxRaw);
                const count = ctxs.length;
                
                // Show a button for each found version
                const div = document.createElement('div');
                div.className = 'found-item';
                div.innerHTML = `
                    <div style="font-weight:bold; font-size:18px;">Found Version: ${ver}</div>
                    <div>Contains <b>${count} Contexts</b> (Tabs)</div>
                    <div style="font-size:12px; color:#666; margin-top:5px;">
                        Tabs found: ${ctxs.map(c => c.l).join(', ')}
                    </div>
                    <button class="btn" onclick="restoreVersion('${ver}')">Restore This Data</button>
                `;
                resultsDiv.appendChild(div);
            }
        });

        if (!foundAny) {
            resultsDiv.innerHTML = `<div style="padding:20px; text-align:center; color:red;">No previous data found. Starting fresh.</div>`;
            setTimeout(() => {
                loadFresh();
            }, 2000);
        }
    }

    function restoreVersion(ver) {
        if(confirm(`Restore data from ${ver}?`)) {
            // Load from that specific version key
            currentData.contexts = JSON.parse(localStorage.getItem(`sk_ctx_${ver}`) || '[]');
            currentData.bank = JSON.parse(localStorage.getItem(`sk_bank_${ver}`) || '[]');
            currentData.assignments = JSON.parse(localStorage.getItem(`sk_assign_${ver}`) || '{}');
            currentData.history = JSON.parse(localStorage.getItem(`sk_h_${ver}`) || '{}');
            
            // SAVE into a stable "v_final" key so we stop jumping versions
            saveToFinal();
            
            // Hide recovery, show app
            document.getElementById('recoveryScreen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            initApp();
        }
    }

    function loadFresh() {
        currentData = JSON.parse(JSON.stringify(DEFAULTS));
        document.getElementById('recoveryScreen').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        initApp();
    }

    // --- 2. STORAGE HANDLING (Stable) ---
    // We now use 'sk_final' keys to stop the version madness
    const KEYS = { C: 'sk_ctx_final', B: 'sk_bank_final', A: 'sk_assign_final', H: 'sk_h_final' };

    function saveToFinal() {
        localStorage.setItem(KEYS.C, JSON.stringify(currentData.contexts));
        localStorage.setItem(KEYS.B, JSON.stringify(currentData.bank));
        localStorage.setItem(KEYS.A, JSON.stringify(currentData.assignments));
        localStorage.setItem(KEYS.H, JSON.stringify(currentData.history));
    }

    // --- 3. EXPORT FUNCTION (Crucial) ---
    window.exportData = function() {
        const dataStr = JSON.stringify(currentData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `skeleton_backup_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
    };

    // --- 4. MINI APP ENGINE (Simplified for Rescue) ---
    // This allows you to verify the data is correct immediately
    let activeCtxId = null;
    let qIdx = 0;
    let answers = {};

    function initApp() {
        renderView('welcome');
    }

    window.renderView = function(view) {
        ['welcomeView','loggerView','settingsView','historyView'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById(view+'View').classList.remove('hidden');
        
        if(view === 'welcome') {
            const list = document.getElementById('contextList');
            list.innerHTML = '';
            currentData.contexts.sort((a,b)=>a.order-b.order).forEach(c => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline';
                btn.style.textAlign = 'left';
                btn.innerHTML = `<span style="font-size:20px">${c.i}</span> <b>${c.l}</b>`;
                btn.onclick = () => startLogger(c.id);
                list.appendChild(btn);
            });
            
            // Chips
            const chips = document.getElementById('chips');
            chips.innerHTML = currentData.contexts.map(c => 
                `<div style="background:white; padding:5px 10px; border-radius:15px; border:1px solid #ddd; white-space:nowrap;">${c.i} ${c.l}</div>`
            ).join('');
        }
        
        if(view === 'history') {
             const hList = document.getElementById('historyList');
             const days = Object.keys(currentData.history).sort().reverse();
             if(days.length === 0) hList.innerHTML = "No history found.";
             else {
                 hList.innerHTML = days.map(d => `<div style="padding:10px; border-bottom:1px solid #eee;"><b>${d}</b>: ${currentData.history[d].length} entries</div>`).join('');
             }
        }
    }

    function startLogger(cid) {
        activeCtxId = cid;
        qIdx = 0;
        answers = {};
        renderView('logger');
        renderQuestion();
    }
    
    function renderQuestion() {
        const qIds = currentData.assignments[activeCtxId] || [];
        if(qIds.length === 0) { alert('No questions in this context'); return; }
        
        if(qIdx >= qIds.length) {
            // Save to history
            const today = new Date().toISOString().slice(0,10);
            if(!currentData.history[today]) currentData.history[today] = [];
            currentData.history[today].push({ ctx: activeCtxId, ans: answers, time: new Date().toLocaleTimeString() });
            saveToFinal();
            alert('Saved!');
            renderView('welcome');
            return;
        }

        const q = currentData.bank.find(x => x.id === qIds[qIdx]);
        if(!q) { qIdx++; renderQuestion(); return; } // skip missing

        const ctx = currentData.contexts.find(c => c.id === activeCtxId);
        document.getElementById('logCtxName').innerText = ctx.l;
        document.getElementById('logStep').innerText = `${qIdx+1}/${qIds.length}`;
        document.getElementById('qText').innerText = q.l;
        
        const area = document.getElementById('inputArea');
        area.innerHTML = '';
        
        // Simple input renderer for rescue mode
        let input;
        if(q.t === 'range') {
            input = document.createElement('input'); input.type='range'; input.min=0; input.max=10;
        } else if(q.t === 'toggle') {
            input = document.createElement('input'); input.type='checkbox'; input.style.transform='scale(1.5)';
        } else if(q.t === 'select' || q.t === 'multi') {
            // render buttons for options
             const opts = (q.o || '').split(',');
             opts.forEach(opt => {
                 const b = document.createElement('button');
                 b.className = 'btn btn-outline';
                 b.style.marginBottom = '5px';
                 b.innerText = opt;
                 b.onclick = () => { answers[q.id] = opt; nextQ(); };
                 area.appendChild(b);
             });
             return; // stop here for buttons
        } else {
            input = document.createElement('input'); input.type='text'; input.style.width='100%'; input.style.padding='10px';
        }
        
        input.id = 'curInput';
        area.appendChild(input);
    }

    window.nextQ = function() {
        const inp = document.getElementById('curInput');
        if(inp) {
            const qIds = currentData.assignments[activeCtxId];
            const q = currentData.bank.find(x => x.id === qIds[qIdx]);
            answers[q.id] = (inp.type==='checkbox') ? inp.checked : inp.value;
        }
        qIdx++;
        renderQuestion();
    }
    
    window.prevQ = function() {
        if(qIdx > 0) { qIdx--; renderQuestion(); }
    }

</script>
</body>
</html>
