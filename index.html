<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>skeleton log ¬∑ infinite scroll</title>
    <style>
        /* CSS RESET & BASICS */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f5f5f7; 
            color: #1d1d1f; 
            padding: 20px 12px 60px; /* Added bottom padding for scrolling */
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            /* FIX: Ensure scrolling works for tall content */
            height: auto; 
            overflow-y: auto; 
        }

        .wrap { width: 100%; max-width: 400px; }

        /* CARD STYLES */
        .card { 
            background: #fff; 
            border-radius: 28px; 
            padding: 24px 20px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); 
            min-height: 460px; 
            display: flex; 
            flex-direction: column; 
            margin-bottom: 16px; 
            /* FIX: Allow card to grow infinitely */
            height: auto;
        }

        /* BUTTONS */
        .icon-btn { background: #e8e8ed; border: none; width: 44px; height: 44px; border-radius: 22px; font-size: 22px; cursor: pointer; transition: 0.2s; }
        .icon-btn:active { transform: scale(0.95); }
        .download-btn { background: #007aff; color: white; border: none; padding: 16px; border-radius: 18px; font-weight: 500; width: 100%; margin: 16px 0; cursor: pointer; }
        
        /* CHIPS */
        .chip-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 4px 0 20px; scrollbar-width: none; }
        .chip-scroll::-webkit-scrollbar { display: none; }
        .chip { flex: 0 0 auto; background: #fff; border: 1.5px solid #d2d2d7; padding: 10px 18px; border-radius: 40px; font-weight: 500; font-size: 15px; display: flex; align-items: center; gap: 6px; cursor: pointer; white-space: nowrap; }
        .chip.active { border-color: #007aff; background: #f0f7ff; }
        .chip.completed { border-color: #34c759; background: #f0fff4; }
        
        /* HEADERS */
        .head-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        h1 { font-size: 28px; font-weight: 600; letter-spacing: -0.5px; }

        /* CONTEXT BUTTONS */
        .ctx-btn { background: #f5f5f7; border: none; padding: 18px; border-radius: 20px; font-size: 16px; font-weight: 500; display: flex; align-items: center; gap: 12px; cursor: pointer; width: 100%; margin-bottom: 10px; }
        .ctx-btn:active { opacity: 0.7; }

        /* SETTINGS ACCORDION (FIXED) */
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; cursor: pointer; border-bottom: 1px solid #e8e8ed; margin-top: 16px; }
        .section-title { font-weight: 600; font-size: 16px; }
        
        /* FIX: Removed max-height animation to allow infinite scrolling */
        .section-content { display: block; overflow: visible; }
        .section-content.collapsed { display: none; }

        /* ASSIGNMENT ITEMS */
        .assigned-item { display: flex; align-items: center; gap: 8px; background: white; padding: 10px; border-radius: 12px; margin-bottom: 8px; border: 1px solid #e8e8ed; }
        .assigned-order { background: #007aff; color: white; width: 28px; height: 28px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; flex-shrink: 0; }
        .assigned-text { flex: 1; font-size: 14px; word-break: break-word; }

        /* LOGGER */
        .logger-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid #e8e8ed; }
        .question { font-size: 22px; font-weight: 600; margin-bottom: 32px; text-align: center; line-height: 1.4; }
        .input-area { flex: 1; display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px; }
        
        /* INPUTS */
        input, textarea, select { background: #f5f5f7; border: none; padding: 16px 18px; border-radius: 18px; font-size: 16px; width: 100%; outline: none; }
        .button-row { display: flex; gap: 10px; margin-top: 16px; }
        .button-row button { flex: 1; background: #f5f5f7; border: none; padding: 16px; border-radius: 18px; font-weight: 500; font-size: 15px; cursor: pointer; }
        .button-row .primary { background: #007aff; color: white; }
        
        .option-pill { background: #f5f5f7; padding: 16px 20px; border-radius: 18px; text-align: center; font-weight: 500; cursor: pointer; margin-bottom: 8px; border: 2px solid transparent; }
        .option-pill.active { border-color: #007aff; background: #f0f7ff; }

        /* UTILS */
        .hidden { display: none !important; }
        .auto-save-indicator { font-size: 11px; color: #34c759; text-align: right; margin-top: 8px; opacity: 0.7; }

        /* MODAL */
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; pointer-events: none; transition: 0.2s; z-index: 1000; }
        .modal.active { opacity: 1; pointer-events: all; }
        .modal-card { background: #fff; border-radius: 28px; padding: 28px; width: 100%; max-width: 360px; text-align: center; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 24px; }
        .modal-buttons button { flex: 1; padding: 14px; border-radius: 14px; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <div class="wrap">
        <div class="head-row">
            <h1>skeleton</h1>
            <div>
                <button class="icon-btn" onclick="showView('history')">üìÖ</button>
                <button class="icon-btn" onclick="showView('setup')">‚öôÔ∏è</button>
            </div>
        </div>

        <div class="chip-scroll" id="chipContainer"></div>

        <div class="card">
            <div id="welcomeView">
                <div style="text-align:center; padding:30px 0;">
                    <div style="font-size:64px; margin-bottom:16px;">ü¶¥</div>
                    <div style="margin-bottom:24px; color:#86868b;">Select a context to log:</div>
                    <div id="welcomeGrid"></div>
                </div>
            </div>

            <div id="loggerView" class="hidden">
                <div class="logger-header">
                    <span id="ctxName" style="font-size:18px; font-weight:600;">Context</span>
                    <span id="stepText" style="font-size:12px; color:#86868b;">0/0</span>
                </div>
                <div class="question" id="questionText">loading...</div>
                <div class="input-area" id="inputArea"></div>
                <div class="button-row">
                    <button onclick="handleBack()">‚Üê</button>
                    <button id="skipBtn" onclick="handleSkip()">Skip</button>
                    <button class="primary" onclick="handleNext()">Next ‚Üí</button>
                </div>
            </div>

            <div id="historyView" class="hidden">
                <div class="head-row">
                    <span style="font-size:18px; font-weight:600;">History</span>
                    <button class="icon-btn" onclick="showView('welcome')">‚úï</button>
                </div>
                <div id="historyList" style="text-align:center; color:#86868b; padding:20px;">
                    No history found
                </div>
                <button class="download-btn" onclick="downloadToday()">üì• Download Today's Log</button>
            </div>

            <div id="setupView" class="hidden">
                <div class="head-row">
                    <span style="font-size:18px; font-weight:600;">Settings</span>
                    <button class="icon-btn" onclick="showView('welcome')">‚úï</button>
                </div>
                <div id="autoSaveIndicator" class="auto-save-indicator">‚úì all changes saved</div>

                <div class="section-header" onclick="toggleSection('assignments')">
                    <span class="section-title">üîó Context Assignments (Tabs)</span>
                    <span id="assignmentsToggle">‚ñº</span>
                </div>
                <div id="assignmentsSection" class="section-content">
                    <div id="assignmentEditor"></div>
                </div>

                <div class="section-header" onclick="toggleSection('bank')">
                    <span class="section-title">üìã Question Bank</span>
                    <span id="bankToggle">‚ñ∂</span>
                </div>
                <div id="bankSection" class="section-content collapsed">
                    <div id="bankEditor"></div>
                </div>

                <div class="section-header" onclick="toggleSection('contexts')">
                    <span class="section-title">üìå Manage Tabs</span>
                    <span id="contextsToggle">‚ñ∂</span>
                </div>
                <div id="contextsSection" class="section-content collapsed">
                    <div id="contextEditor"></div>
                    <button class="download-btn" style="background:#e8e8ed; color:black; margin-top:10px;" onclick="addContext()">+ New Tab</button>
                </div>

                <div style="margin-top:30px; border-top:1px solid #eee; padding-top:20px;">
                    <h3 style="margin-bottom:8px;">üíæ Backup</h3>
                    <p style="font-size:13px; color:#86868b; margin-bottom:12px;">Export your data regularly.</p>
                    <button class="download-btn" style="background:#34c759;" onclick="exportBackup()">üì§ Export Backup File</button>
                    
                    <div style="margin-top:16px;">
                        <input type="file" id="importFile" style="display:none" onchange="importBackup(this)">
                        <button class="download-btn" style="background:#f5f5f7; color:#1d1d1f; border:1px solid #d2d2d7;" onclick="document.getElementById('importFile').click()">
                            üì• Import Backup
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-card">
            <div id="modalTitle" style="font-weight:600; margin-bottom:10px; font-size:18px;"></div>
            <div id="modalBody" style="color:#666; margin-bottom:20px;"></div>
            <div class="modal-buttons">
                <button id="modalCancel" style="background:#f5f5f7;">Cancel</button>
                <button id="modalConfirm" style="background:#007aff; color:white;">OK</button>
            </div>
        </div>
    </div>

    <script>
        // *** STORAGE CONFIG: USES v5 TO KEEP YOUR DATA ***
        const STORAGE = {
            CONTEXTS: 'sk_ctx_v5',
            BANK: 'sk_bank_v5',
            ASSIGNMENTS: 'sk_assign_v5',
            HISTORY: 'sk_h_v5',
            PROGRESS: 'sk_p_v5',
            SETTINGS: 'sk_settings_v5'
        };

        // DEFAULTS
        const DEFAULT_CTX = [{ id: 'morn', l: 'Morning', i: 'üåÖ', order: 0 }];
        const DEFAULT_SETTINGS = { sections: { assignments: true, bank: false, contexts: false } };

        // STATE
        let contexts = JSON.parse(localStorage.getItem(STORAGE.CONTEXTS) || JSON.stringify(DEFAULT_CTX));
        let bank = JSON.parse(localStorage.getItem(STORAGE.BANK) || '[]');
        let assignments = JSON.parse(localStorage.getItem(STORAGE.ASSIGNMENTS) || '{}');
        let history = JSON.parse(localStorage.getItem(STORAGE.HISTORY) || '{}');
        let settings = JSON.parse(localStorage.getItem(STORAGE.SETTINGS) || JSON.stringify(DEFAULT_SETTINGS));
        
        let activeCtxId = '';
        let currentQIndex = 0;
        let answers = {};
        let autoSaveTimer = null;
        let selectedAssignmentContext = null;

        // --- CORE FUNCTIONS ---

        function showView(view) {
            ['welcomeView','loggerView','setupView','historyView'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(view+'View').classList.remove('hidden');
            
            if(view === 'welcome') renderWelcome();
            if(view === 'setup') renderEditor();
            if(view === 'history') renderHistory();
            renderChips();
        }

        function renderChips() {
            const chips = document.getElementById('chipContainer');
            let html = '';
            contexts.sort((a,b)=>a.order-b.order).forEach(ctx => {
                const today = new Date().toISOString().slice(0,10);
                const isDone = history[today]?.some(x => x.ctx === ctx.id);
                const style = isDone ? 'border-color:#34c759; background:#f0fff4;' : '';
                html += `<div class="chip" style="${style}" onclick="startContext('${ctx.id}')">${ctx.i} ${ctx.l}</div>`;
            });
            chips.innerHTML = html;
        }

        function renderWelcome() {
            const grid = document.getElementById('welcomeGrid');
            let html = '';
            contexts.sort((a,b)=>a.order-b.order).forEach(ctx => {
                html += `<button class="ctx-btn" onclick="startContext('${ctx.id}')"><span>${ctx.i}</span> ${ctx.l}</button>`;
            });
            grid.innerHTML = html;
        }

        // --- LOGGER ---

        function startContext(id) {
            activeCtxId = id;
            currentQIndex = 0;
            answers = {};
            const qIds = assignments[id] || [];
            
            if(qIds.length === 0) { 
                modal.show('Empty Tab', 'No questions assigned to this tab yet. Go to Settings ‚öôÔ∏è to add some.', null);
                return; 
            }
            
            showView('logger');
            renderQuestion();
        }

        function renderQuestion() {
            const ctx = contexts.find(c => c.id === activeCtxId);
            const qIds = assignments[activeCtxId];
            const q = bank.find(x => x.id === qIds[currentQIndex]);
            
            if (!q) {
                // Question missing from bank? Skip it.
                currentQIndex++;
                if (currentQIndex < qIds.length) renderQuestion();
                else completeContext();
                return;
            }

            document.getElementById('ctxName').innerText = ctx.l;
            document.getElementById('stepText').innerText = `${currentQIndex+1}/${qIds.length}`;
            document.getElementById('questionText').innerText = q.l;
            
            const area = document.getElementById('inputArea');
            area.innerHTML = '';
            
            // Render Input Type
            if(q.t === 'select' || q.t === 'multi') {
                (q.o || '').split(',').forEach(opt => {
                    opt = opt.trim();
                    if(!opt) return;
                    const btn = document.createElement('div');
                    btn.className = 'option-pill';
                    btn.innerText = opt;
                    
                    // Highlight if selected
                    if(q.t === 'select' && answers[q.id] === opt) btn.classList.add('active');
                    if(q.t === 'multi' && Array.isArray(answers[q.id]) && answers[q.id].includes(opt)) btn.classList.add('active');
                    
                    btn.onclick = () => {
                        if(q.t === 'select') {
                            answers[q.id] = opt;
                            handleNext();
                        } else {
                            if(!Array.isArray(answers[q.id])) answers[q.id] = [];
                            const idx = answers[q.id].indexOf(opt);
                            if(idx > -1) answers[q.id].splice(idx,1); else answers[q.id].push(opt);
                            renderQuestion(); // re-render to update active class
                        }
                    };
                    area.appendChild(btn);
                });
            } else if (q.t === 'toggle') {
                const checked = answers[q.id] === true;
                area.innerHTML = `<div onclick="toggleBool('${q.id}')" class="option-pill ${checked?'active':''}" style="font-size:20px;">${checked?'YES':'NO'}</div>`;
            } else if (q.t === 'range') {
                const val = answers[q.id] || 5;
                area.innerHTML = `
                    <div style="text-align:center; font-size:40px; font-weight:bold; color:#007aff; margin-bottom:10px;">${val}</div>
                    <input type="range" min="0" max="10" step="0.5" value="${val}" style="width:100%; height:40px;" oninput="updateRange(this, '${q.id}')">
                `;
            } else {
                const val = answers[q.id] || '';
                area.innerHTML = `<input type="text" id="curInput" value="${val}" placeholder="Type answer..." oninput="answers['${q.id}'] = this.value">`;
            }
        }
        
        window.toggleBool = function(qid) {
            answers[qid] = !answers[qid];
            renderQuestion();
        }
        window.updateRange = function(el, qid) {
            answers[qid] = el.value;
            el.previousElementSibling.innerText = el.value;
        }

        function handleSkip() {
            const qIds = assignments[activeCtxId];
            if(currentQIndex < qIds.length - 1) {
                currentQIndex++;
                renderQuestion();
            } else {
                completeContext();
            }
        }

        function handleNext() {
            // Text inputs are captured via oninput, so just move on
            handleSkip();
        }

        function handleBack() {
            if(currentQIndex > 0) { currentQIndex--; renderQuestion(); }
            else showView('welcome');
        }

        function completeContext() {
            const today = new Date().toISOString().slice(0,10);
            if(!history[today]) history[today] = [];
            
            history[today].push({
                ctx: activeCtxId,
                ans: answers,
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
            });
            localStorage.setItem(STORAGE.HISTORY, JSON.stringify(history));
            
            // Visual feedback
            modal.show('Saved!', 'Log entry saved successfully.', () => showView('welcome'));
        }

        // --- SETTINGS EDITOR (FIXED SCROLL) ---

        function renderEditor() {
            // Assignments
            const assignDiv = document.getElementById('assignmentEditor');
            let html = '';
            contexts.sort((a,b)=>a.order-b.order).forEach(ctx => {
                const qIds = assignments[ctx.id] || [];
                html += `<div style="margin-bottom:20px;">
                    <div style="font-weight:600; margin-bottom:10px;">${ctx.i} ${ctx.l}</div>`;
                
                if(qIds.length > 0) {
                    qIds.forEach((qid, idx) => {
                        const q = bank.find(x => x.id === qid);
                        if(q) {
                            html += `<div class="assigned-item">
                                <span class="assigned-order">${idx+1}</span>
                                <span class="assigned-text">${q.l}</span>
                                <button onclick="removeFromContext('${ctx.id}', '${qid}')" style="background:none; border:none; font-size:18px;">‚úï</button>
                            </div>`;
                        }
                    });
                } else {
                    html += `<div style="color:#aaa; font-size:13px; margin-bottom:5px;">No questions assigned</div>`;
                }

                // Add dropdown
                const avail = bank.filter(b => !qIds.includes(b.id));
                if(avail.length > 0) {
                    html += `<select onchange="addToContext('${ctx.id}', this.value); this.value='';" style="margin-top:5px;">
                        <option value="">+ Add Question...</option>
                        ${avail.map(q => `<option value="${q.id}">${q.l}</option>`).join('')}
                    </select>`;
                }
                html += `</div>`;
            });
            assignDiv.innerHTML = html;

            // Bank
            const bankDiv = document.getElementById('bankEditor');
            bankDiv.innerHTML = bank.map(q => `
                <div style="background:#f5f5f7; padding:10px; border-radius:12px; margin-bottom:10px; border-left:4px solid #007aff;">
                    <div style="display:flex; justify-content:space-between;">
                        <b>${q.l}</b>
                        <button onclick="deleteFromBank('${q.id}')" style="border:none; background:none; color:red;">‚úï</button>
                    </div>
                    <div style="font-size:12px; color:#666;">Type: ${q.t}</div>
                </div>
            `).join('') + `
            <button class="download-btn" onclick="addToBank()">+ Create New Question</button>
            `;

            // Contexts
            document.getElementById('contextEditor').innerHTML = contexts.map(c => `
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <input value="${c.i}" onchange="updateCtx('${c.id}', 'i', this.value)" style="width:50px; text-align:center;">
                    <input value="${c.l}" onchange="updateCtx('${c.id}', 'l', this.value)">
                    <button onclick="deleteContext('${c.id}')" style="background:#ff3b30; color:white; border:none; width:40px; border-radius:10px;">‚úï</button>
                </div>
            `).join('');

            // Restore accordion state
            Object.keys(settings.sections).forEach(k => {
                const el = document.getElementById(k+'Section');
                const tog = document.getElementById(k+'Toggle');
                if(settings.sections[k]) {
                    el.classList.remove('collapsed');
                    tog.innerText = '‚ñº';
                } else {
                    el.classList.add('collapsed');
                    tog.innerText = '‚ñ∂';
                }
            });
        }

        function toggleSection(key) {
            settings.sections[key] = !settings.sections[key];
            localStorage.setItem(STORAGE.SETTINGS, JSON.stringify(settings));
            renderEditor();
        }

        // --- EDITOR ACTIONS ---
        window.addToContext = function(ctxId, qId) {
            if(!assignments[ctxId]) assignments[ctxId] = [];
            assignments[ctxId].push(qId);
            saveAll();
        };

        window.removeFromContext = function(ctxId, qId) {
            assignments[ctxId] = assignments[ctxId].filter(x => x !== qId);
            saveAll();
        };

        window.addToBank = function() {
            const l = prompt("Question Text:");
            if(!l) return;
            const t = prompt("Type (text, range, select, toggle, multi):", "text");
            let o = "";
            if(t === 'select' || t === 'multi') o = prompt("Options (comma separated):", "Good, Bad");
            
            const newId = 'q' + Date.now();
            bank.push({id: newId, l, t, o});
            saveAll();
        };
        
        window.deleteFromBank = function(qid) {
            if(confirm('Delete question?')) {
                bank = bank.filter(b => b.id !== qid);
                // remove from assigns
                Object.keys(assignments).forEach(k => {
                    assignments[k] = assignments[k].filter(x => x !== qid);
                });
                saveAll();
            }
        };

        window.updateCtx = function(id, field, val) {
            const c = contexts.find(x => x.id === id);
            if(c) { c[field] = val; saveAll(); }
        };

        window.addContext = function() {
            const l = prompt("Tab Name:", "New Tab");
            if(l) {
                const id = 'ctx' + Date.now();
                contexts.push({ id, l, i:'üìå', order: contexts.length });
                assignments[id] = [];
                saveAll();
            }
        };
        
        window.deleteContext = function(id) {
            if(confirm('Delete tab?')) {
                contexts = contexts.filter(c => c.id !== id);
                delete assignments[id];
                saveAll();
            }
        };

        function saveAll() {
            localStorage.setItem(STORAGE.ASSIGNMENTS, JSON.stringify(assignments));
            localStorage.setItem(STORAGE.BANK, JSON.stringify(bank));
            localStorage.setItem(STORAGE.CONTEXTS, JSON.stringify(contexts));
            renderEditor();
            document.getElementById('autoSaveIndicator').style.opacity = '1';
            setTimeout(() => document.getElementById('autoSaveIndicator').style.opacity = '0.5', 1000);
        }

        // --- BACKUP ---
        window.exportBackup = function() {
            const data = { contexts, bank, assignments, history, version:'fixed_v5' };
            const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `skeleton_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };
        
        window.importBackup = function(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const d = JSON.parse(e.target.result);
                    if(confirm('Restore data from backup?')) {
                        localStorage.setItem(STORAGE.CONTEXTS, JSON.stringify(d.contexts));
                        localStorage.setItem(STORAGE.BANK, JSON.stringify(d.bank));
                        localStorage.setItem(STORAGE.ASSIGNMENTS, JSON.stringify(d.assignments));
                        localStorage.setItem(STORAGE.HISTORY, JSON.stringify(d.history));
                        location.reload();
                    }
                } catch(err) { alert('Error: ' + err.message); }
            };
            reader.readAsText(file);
        };
        
        // --- HISTORY ---
        function renderHistory() {
            const list = document.getElementById('historyList');
            const today = new Date().toISOString().slice(0,10);
            const logs = history[today] || [];
            
            if(logs.length === 0) {
                list.innerHTML = 'No logs for today yet.';
                return;
            }
            
            list.innerHTML = logs.map(l => {
                const c = contexts.find(x => x.id === l.ctx) || {l:'Unknown'};
                return `<div style="background:#f5f5f7; padding:10px; border-radius:12px; margin-bottom:10px; text-align:left;">
                    <b>${c.l}</b> @ ${l.time}
                </div>`;
            }).join('');
        }
        
        window.downloadToday = function() {
            const today = new Date().toISOString().slice(0,10);
            const logs = history[today] || [];
            if(logs.length === 0) { alert('No logs today'); return; }
            let txt = `LOGS: ${today}\n\n`;
            logs.forEach(l => {
                const c = contexts.find(x => x.id === l.ctx) || {l:l.ctx};
                txt += `--- ${c.l} (${l.time}) ---\n`;
                Object.keys(l.ans).forEach(qid => {
                    const q = bank.find(x => x.id === qid);
                    if(q) txt += `${q.l}: ${l.ans[qid]}\n`;
                });
                txt += '\n';
            });
            const blob = new Blob([txt], {type:'text/plain'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `log_${today}.txt`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };

        // --- MODAL ---
        const modal = {
            el: document.getElementById('modal'),
            show(t, b, cb) {
                document.getElementById('modalTitle').innerText = t;
                document.getElementById('modalBody').innerText = b;
                const btn = document.getElementById('modalConfirm');
                btn.onclick = () => { if(cb) cb(); modal.el.classList.remove('active'); };
                document.getElementById('modalCancel').onclick = () => modal.el.classList.remove('active');
                modal.el.classList.add('active');
            }
        };

        // INIT
        window.onload = () => { renderWelcome(); };

    </script>
</body>
</html>
