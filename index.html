<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>skeleton log ¬∑ backup enabled</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f7; color: #1d1d1f; padding: 16px 12px 32px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        .wrap { width: 100%; max-width: 400px; }
        .head-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        h1 { font-size: 28px; font-weight: 600; letter-spacing: -0.5px; }
        .icon-btn { background: #e8e8ed; border: none; width: 44px; height: 44px; border-radius: 22px; font-size: 22px; cursor: pointer; transition: 0.2s; }
        .icon-btn:active { transform: scale(0.95); }
        .chip-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 4px 0 20px; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .chip-scroll::-webkit-scrollbar { display: none; }
        .chip { flex: 0 0 auto; background: #fff; border: 1.5px solid #d2d2d7; padding: 10px 18px; border-radius: 40px; font-weight: 500; font-size: 15px; display: flex; align-items: center; gap: 6px; cursor: pointer; position: relative; white-space: nowrap; }
        .chip.active { border-color: #007aff; background: #f0f7ff; }
        .chip.completed::after { content: ''; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; border-radius: 6px; background: #34c759; }
        .chip.in-progress::after { background: #ff9f0a; content: ''; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; border-radius: 6px; }
        .progress-badge { position: absolute; top: -6px; right: -4px; background: #007aff; color: white; font-size: 10px; font-weight: 600; min-width: 18px; height: 18px; border-radius: 18px; display: flex; align-items: center; justify-content: center; padding: 0 4px; }
        .card { background: #fff; border-radius: 28px; padding: 24px 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); min-height: 460px; display: flex; flex-direction: column; margin-bottom: 16px; }
        .welcome { text-align: center; padding: 30px 0 20px; }
        .welcome-emoji { font-size: 64px; margin-bottom: 16px; }
        .welcome-title { font-size: 26px; font-weight: 600; margin-bottom: 12px; }
        .welcome-desc { color: #86868b; font-size: 15px; margin-bottom: 32px; line-height: 1.5; }
        .context-grid { display: flex; flex-direction: column; gap: 10px; margin-bottom: 24px; }
        .ctx-btn { background: #f5f5f7; border: none; padding: 18px; border-radius: 20px; font-size: 16px; font-weight: 500; display: flex; align-items: center; gap: 12px; cursor: pointer; width: 100%; }
        .ctx-btn:active { opacity: 0.7; }
        .ctx-btn small { margin-left: auto; font-size: 13px; color: #86868b; }
        .ctx-btn:disabled { opacity: 0.5; }
        .logger-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid #e8e8ed; }
        .logger-context { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .logger-status { font-size: 12px; padding: 4px 12px; border-radius: 30px; background: #f0f7ff; color: #007aff; }
        .progress-bar { height: 4px; background: #e8e8ed; border-radius: 4px; margin: 8px 0 24px; overflow: hidden; }
        .progress-fill { height: 100%; background: #007aff; width: 0%; transition: width 0.3s; }
        .question { font-size: 22px; font-weight: 600; margin-bottom: 32px; text-align: center; line-height: 1.4; }
        .input-area { flex: 1; display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px; }
        input, textarea, select { background: #f5f5f7; border: none; padding: 16px 18px; border-radius: 18px; font-size: 16px; width: 100%; outline: none; }
        input[type="time"] { text-align: center; font-size: 22px; }
        input[type="range"] { padding: 0; height: 44px; }
        .range-display { font-size: 42px; font-weight: 600; color: #007aff; text-align: center; margin-bottom: 8px; }
        .option-pill { background: #f5f5f7; padding: 16px 20px; border-radius: 18px; text-align: center; font-weight: 500; cursor: pointer; border: 2px solid transparent; margin-bottom: 8px; }
        .option-pill.active { border-color: #007aff; background: #f0f7ff; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; margin: 0 auto; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #e8e8ed; border-radius: 34px; transition: 0.2s; }
        .slider:before { position: absolute; content: ""; height: 28px; width: 28px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.2s; }
        input:checked + .slider { background: #007aff; }
        input:checked + .slider:before { transform: translateX(26px); }
        .button-row { display: flex; gap: 10px; margin-top: 16px; }
        .button-row button { flex: 1; background: #f5f5f7; border: none; padding: 16px; border-radius: 18px; font-weight: 500; font-size: 15px; cursor: pointer; }
        .button-row button:active { opacity: 0.7; }
        .button-row .primary { background: #007aff; color: white; }
        .step { text-align: center; font-size: 13px; color: #86868b; margin: 16px 0 8px; }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .history-title { font-size: 18px; font-weight: 600; }
        .search-box { background: #f5f5f7; border: none; padding: 14px 18px; border-radius: 18px; width: 100%; margin-bottom: 20px; }
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 24px; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 14px; background: #f5f5f7; border-radius: 12px; cursor: pointer; position: relative; }
        .cal-day.today { border: 2px solid #007aff; }
        .cal-day.has-data { font-weight: 600; color: #007aff; }
        .cal-day.has-data::after { content: ''; position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; border-radius: 4px; background: #34c759; }
        .history-entry { background: #f5f5f7; padding: 16px; border-radius: 18px; margin-bottom: 12px; position: relative; }
        .entry-header { display: flex; justify-content: space-between; margin-bottom: 12px; font-weight: 600; }
        .entry-delete { position: absolute; top: 12px; right: 12px; background: none; border: none; font-size: 18px; color: #ff3b30; cursor: pointer; padding: 8px; }
        .entry-answer { padding: 6px 0; border-bottom: 1px solid #e8e8ed; font-size: 14px; }
        .download-btn { background: #007aff; color: white; border: none; padding: 16px; border-radius: 18px; font-weight: 500; width: 100%; margin: 16px 0; cursor: pointer; }
        .summary-emoji { font-size: 64px; text-align: center; margin: 20px 0; }
        .summary-item { padding: 12px 0; border-bottom: 1px solid #e8e8ed; }
        .summary-label { font-size: 12px; color: #86868b; text-transform: uppercase; margin-bottom: 4px; }
        .summary-value { font-size: 16px; font-weight: 500; }
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; cursor: pointer; border-bottom: 1px solid #e8e8ed; margin-top: 16px; }
        .section-header:first-of-type { margin-top: 0; }
        .section-title { font-weight: 600; font-size: 16px; }
        .section-toggle { background: none; border: none; font-size: 18px; width: 36px; height: 36px; border-radius: 18px; cursor: pointer; }
        .section-content { transition: max-height 0.3s ease; overflow: hidden; max-height: 2000px; }
        .section-content.collapsed { max-height: 0; }
        .context-item { background: #f5f5f7; padding: 16px; border-radius: 16px; margin-bottom: 12px; }
        .bank-item { background: #f5f5f7; padding: 16px; border-radius: 16px; margin-bottom: 12px; border-left: 4px solid #007aff; }
        .bank-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .bank-title { font-weight: 600; font-size: 16px; }
        .bank-tags { display: flex; flex-wrap: wrap; gap: 6px; margin: 8px 0; }
        .context-tag { background: #e8e8ed; padding: 6px 12px; border-radius: 30px; font-size: 12px; display: inline-block; }
        .context-tag.active { background: #007aff; color: white; }
        .reorder-controls { display: flex; gap: 6px; margin-top: 10px; }
        .badge { background: #007aff20; color: #007aff; padding: 4px 8px; border-radius: 30px; font-size: 11px; font-weight: 600; }
        .assigned-item { display: flex; align-items: center; gap: 8px; background: white; padding: 10px; border-radius: 12px; margin-bottom: 8px; border: 1px solid #e8e8ed; cursor: pointer; transition: 0.2s; }
        .assigned-item.selected { border-color: #007aff; background: #f0f7ff; }
        .assigned-order { background: #007aff; color: white; width: 28px; height: 28px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; }
        .assigned-text { flex: 1; font-size: 14px; }
        .auto-save-indicator { font-size: 11px; color: #34c759; text-align: right; margin-top: 8px; opacity: 0.7; }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; pointer-events: none; transition: 0.2s; z-index: 1000; }
        .modal.active { opacity: 1; pointer-events: all; }
        .modal-card { background: #fff; border-radius: 28px; padding: 28px; width: 100%; max-width: 360px; text-align: center; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 24px; }
        .modal-buttons button { flex: 1; padding: 14px; border-radius: 14px; border: none; cursor: pointer; }
        .hidden { display: none !important; }
        footer { font-size: 11px; color: #86868b; text-align: center; }
    </style>
</head>
<body>
    <div class="wrap">
        <div class="head-row">
            <h1>skeleton</h1>
            <div>
                <button class="icon-btn" onclick="showView('history')">üìÖ</button>
                <button class="icon-btn" onclick="showView('setup')">‚öôÔ∏è</button>
            </div>
        </div>

        <div class="chip-scroll" id="chipContainer"></div>

        <div class="card">
            <div id="welcomeView">
                <div class="welcome">
                    <div class="welcome-emoji">ü¶¥</div>
                    <div class="welcome-title">daily log</div>
                    <div class="welcome-desc">track your day with simple prompts</div>
                    <div class="context-grid" id="welcomeGrid"></div>
                    <button class="download-btn" style="background:#e8e8ed; color:#000;" onclick="fastStart()">‚è±Ô∏è auto</button>
                </div>
            </div>

            <div id="loggerView" class="hidden">
                <div class="logger-header">
                    <div class="logger-context">
                        <span id="ctxIcon">üåÖ</span>
                        <span id="ctxName">Morning</span>
                    </div>
                    <div class="logger-status" id="ctxStatus">ready</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>

                <div id="resumeBanner" style="background:#f0f7ff; padding:12px; border-radius:16px; margin-bottom:20px; text-align:center; display:none;">
                    <div style="font-weight:500;">unfinished session</div>
                    <div style="display:flex; gap:10px; margin-top:8px;">
                        <button style="flex:1; padding:8px; border-radius:12px; border:none; background:#007aff; color:white;" onclick="resumeProgress()">resume</button>
                        <button style="flex:1; padding:8px; border-radius:12px; border:none; background:#e8e8ed;" onclick="resetProgress()">fresh</button>
                    </div>
                </div>

                <div class="question" id="questionText">loading...</div>
                <div class="input-area" id="inputArea"></div>

                <div class="button-row">
                    <button id="backBtn" onclick="handleBack()">‚Üê</button>
                    <button id="skipBtn" onclick="handleSkip()">skip</button>
                    <button class="primary" id="nextBtn" onclick="handleNext()">‚Üí</button>
                </div>
                <div class="step" id="stepText">0/0</div>
            </div>

            <div id="historyView" class="hidden">
                <div class="history-header">
                    <span class="history-title">history</span>
                    <button class="icon-btn" style="width:36px; height:36px;" onclick="showView('welcome')">‚úï</button>
                </div>
                <input type="search" class="search-box" id="searchInput" placeholder="search..." oninput="searchHistory()">
                <div class="calendar" id="calendar"></div>
                <div id="historyEntries"></div>
                <div id="dayDownloadBtn" style="display:none; margin:16px 0;">
                    <button class="download-btn" onclick="downloadCurrentDay()">üì• download .txt</button>
                </div>
            </div>

            <div id="setupView" class="hidden">
                <div class="history-header">
                    <span class="history-title">settings</span>
                    <button class="icon-btn" style="width:36px; height:36px;" onclick="showView('welcome')">‚úï</button>
                </div>

                <div id="autoSaveIndicator" class="auto-save-indicator">‚úì all changes saved</div>

                <div class="section-header" onclick="toggleSection('contexts')">
                    <span class="section-title">üìå contexts</span>
                    <div style="display:flex; gap:8px;">
                        <button class="icon-btn" style="width:36px; height:36px;" onclick="event.stopPropagation(); addContext()">+</button>
                        <span class="section-toggle" id="contextsToggle">‚ñº</span>
                    </div>
                </div>
                <div id="contextsSection" class="section-content">
                    <div id="contextEditor" style="padding: 8px 0 16px;"></div>
                </div>

                <div class="section-header" onclick="toggleSection('bank')">
                    <span class="section-title">üìã question bank</span>
                    <div style="display:flex; gap:8px;">
                        <button class="icon-btn" style="width:36px; height:36px;" onclick="event.stopPropagation(); addToBank()">+</button>
                        <span class="section-toggle" id="bankToggle">‚ñº</span>
                    </div>
                </div>
                <div id="bankSection" class="section-content">
                    <div style="padding: 8px 0 16px;">
                        <p style="color:#86868b; margin-bottom:12px;">master list of all questions (no duplicates)</p>
                        <div id="bankEditor"></div>
                    </div>
                </div>

                <div class="section-header" onclick="toggleSection('assignments')">
                    <span class="section-title">üîó assign to contexts</span>
                    <span class="section-toggle" id="assignmentsToggle">‚ñº</span>
                </div>
                <div id="assignmentsSection" class="section-content">
                    <div style="padding: 16px 0;">
                        <p style="color:#86868b; margin-bottom:12px;">select which contexts see each question</p>
                        <div id="assignmentEditor"></div>
                    </div>
                </div>

                <div style="margin-top:24px; padding-top:24px; border-top:1px solid #e8e8ed;">
                    <div style="font-weight:600; margin-bottom:8px;">üíæ Backup & Restore</div>
                    <p style="font-size:13px; color:#86868b; margin-bottom:12px;">
                        Save your configuration and history to a file. Use this to transfer to a new device.
                    </p>
                    
                    <button class="download-btn" style="background:#34c759; margin-bottom:12px;" onclick="exportBackup()">
                        üì§ Export Backup File
                    </button>
                    
                    <div style="display:flex; gap:10px;">
                        <button class="download-btn" style="background:#f5f5f7; color:#1d1d1f; border:1px solid #d2d2d7;" onclick="document.getElementById('importFile').click()">
                            üì• Import Backup
                        </button>
                        <button class="download-btn" style="background:#ff3b30; flex:0.4;" onclick="hardReset()">
                            ‚ö†Ô∏è Reset
                        </button>
                    </div>
                    <input type="file" id="importFile" style="display:none" onchange="importBackup(this)">
                </div>
            </div>

            <div id="summaryView" class="hidden">
                <div class="summary-emoji">‚ú®</div>
                <div style="font-size:22px; font-weight:600; text-align:center; margin-bottom:20px;">complete</div>
                <div id="summaryContent"></div>
                <button class="download-btn" onclick="downloadToday()">üì• download today</button>
                <button style="background:none; border:none; color:#007aff; margin-top:16px;" onclick="showView('welcome')">‚Üê home</button>
            </div>
        </div>

        <footer>v3.0.0 ¬∑ safe backup enabled</footer>
    </div>

    <div class="modal" id="modal">
        <div class="modal-card">
            <div id="modalTitle" style="font-size:18px; font-weight:600; margin-bottom:12px;">title</div>
            <div id="modalBody" style="color:#86868b; margin-bottom:20px;">message</div>
            <div class="modal-buttons">
                <button id="modalCancel" style="background:#f5f5f7;">cancel</button>
                <button id="modalConfirm" style="background:#007aff; color:white;">ok</button>
            </div>
        </div>
    </div>

    <script>
        // ---------- STORAGE KEYS (KEPT SAME AS v6 TO PRESERVE DATA) ----------
        const STORAGE = {
            CONTEXTS: 'sk_ctx_v5',
            BANK: 'sk_bank_v5',
            ASSIGNMENTS: 'sk_assign_v5',
            HISTORY: 'sk_h_v5',
            PROGRESS: 'sk_p_v5',
            SETTINGS: 'sk_settings_v5'
        };

        // ---------- DEFAULTS (IN CASE OF RESET) ----------
        const DEFAULT_CTX = [
            { id: 'morn', l: 'Morning', i: 'üåÖ', order: 0 },
            { id: 'aft', l: 'Afternoon', i: '‚òÄÔ∏è', order: 1 },
            { id: 'eve', l: 'Evening', i: 'üåô', order: 2 }
        ];

        const DEFAULT_BANK = [
            // Morning
            { id: 'm1', l: 'Sleep Quality (1-10)', t: 'range', o: '', d: '7', created: Date.now() },
            { id: 'm2', l: 'Daily Intent', t: 'text', o: '', d: '', created: Date.now() },
            { id: 'm3', l: 'Morning Sun?', t: 'toggle', o: '', d: false, created: Date.now() },
            // Afternoon
            { id: 'a1', l: 'Focus Level (1-10)', t: 'range', o: '', d: '5', created: Date.now() },
            { id: 'a2', l: 'Current Mood', t: 'select', o: 'Productive,Sluggish,Anxious,Steady', d: 'Steady', created: Date.now() },
            { id: 'pt1', l: 'Physical Tension', t: 'multi', o: 'Jaw,Neck,Shoulders,Back,Eyes,None', d: [], created: Date.now() },
            // Evening
            { id: 'e1', l: 'Today\'s Highlight', t: 'textarea', o: '', d: '', created: Date.now() },
            { id: 'e2', l: 'Stress Peak (0-10)', t: 'range', o: '', d: '3', created: Date.now() },
            { id: 'e3', l: 'Wins', t: 'multi', o: 'Work,Health,Social,Learning', d: [], created: Date.now() }
        ];

        const DEFAULT_ASSIGNMENTS = {
            'morn': ['m1', 'm2', 'm3'],
            'aft': ['a1', 'a2', 'pt1'],
            'eve': ['e1', 'e2', 'e3']
        };

        const DEFAULT_SETTINGS = {
            sections: { contexts: true, bank: true, assignments: false }
        };

        // ---------- STATE ----------
        let contexts = JSON.parse(localStorage.getItem(STORAGE.CONTEXTS) || JSON.stringify(DEFAULT_CTX));
        let bank = JSON.parse(localStorage.getItem(STORAGE.BANK) || JSON.stringify(DEFAULT_BANK));
        let assignments = JSON.parse(localStorage.getItem(STORAGE.ASSIGNMENTS) || JSON.stringify(DEFAULT_ASSIGNMENTS));
        let history = JSON.parse(localStorage.getItem(STORAGE.HISTORY) || '{}');
        let progress = JSON.parse(localStorage.getItem(STORAGE.PROGRESS) || '{}');
        let settings = JSON.parse(localStorage.getItem(STORAGE.SETTINGS) || JSON.stringify(DEFAULT_SETTINGS));

        let activeContext = '';
        let currentQIndex = 0;
        let answers = {};
        let currentView = 'welcome';
        let currentViewedDate = '';
        let selectedAssignmentContext = null;
        let selectedAssignmentIndex = -1;
        let autoSaveTimer = null;
        let pendingChanges = false;

        // ---------- HELPERS ----------
        function getToday() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }
        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/[&<>"]/g, function(c) {
                if(c==='&') return '&amp;'; if(c==='<') return '&lt;'; if(c==='>') return '&gt;'; if(c==='"') return '&quot;';
                return c;
            });
        }
        function triggerAutoSave() {
            pendingChanges = true;
            document.getElementById('autoSaveIndicator').innerText = '‚úé editing...';
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                syncFromEditor();
                localStorage.setItem(STORAGE.CONTEXTS, JSON.stringify(contexts));
                localStorage.setItem(STORAGE.BANK, JSON.stringify(bank));
                localStorage.setItem(STORAGE.ASSIGNMENTS, JSON.stringify(assignments));
                pendingChanges = false;
                document.getElementById('autoSaveIndicator').innerText = '‚úì all changes saved';
            }, 3000);
        }
        function addBlurListeners() {
            document.querySelectorAll('input, select, textarea').forEach(el => {
                el.removeEventListener('blur', triggerAutoSave);
                el.addEventListener('blur', triggerAutoSave);
            });
        }
        function getQuestionsForContext(contextId) {
            const questionIds = assignments[contextId] || [];
            return questionIds.map(id => bank.find(q => q.id === id)).filter(q => q).map((q, index) => ({ ...q, order: index }));
        }

        // ---------- MODAL ----------
        const modal = {
            el: document.getElementById('modal'),
            title: document.getElementById('modalTitle'),
            body: document.getElementById('modalBody'),
            confirm: null,
            init() {
                document.getElementById('modalConfirm').onclick = () => { if(this.confirm) this.confirm(); this.close(); };
                document.getElementById('modalCancel').onclick = () => this.close();
                this.el.onclick = (e) => { if(e.target === this.el) this.close(); };
            },
            show(t, b, onConfirm) {
                this.title.innerText = t;
                this.body.innerText = b;
                this.confirm = onConfirm;
                this.el.classList.add('active');
            },
            close() {
                this.el.classList.remove('active');
                this.confirm = null;
            }
        };

        // ---------- UI ----------
        function showView(view) {
            currentView = view;
            ['welcomeView','loggerView','historyView','setupView','summaryView'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(view + 'View').classList.remove('hidden');
            if (view === 'history') renderCalendar();
            if (view === 'welcome') renderWelcomeGrid();
            if (view === 'setup') { renderEditor(); addBlurListeners(); }
            renderChips();
        }
        function toggleSection(section) {
            const content = document.getElementById(section + 'Section');
            const toggle = document.getElementById(section + 'Toggle');
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed'); toggle.innerText = '‚ñº'; settings.sections[section] = true;
            } else {
                content.classList.add('collapsed'); toggle.innerText = '‚ñ∂'; settings.sections[section] = false;
            }
            localStorage.setItem(STORAGE.SETTINGS, JSON.stringify(settings));
        }
        function renderChips() {
            const today = getToday();
            const sortedContexts = [...contexts].sort((a, b) => (a.order || 0) - (b.order || 0));
            document.getElementById('chipContainer').innerHTML = sortedContexts.map(ctx => {
                const status = getContextStatus(today, ctx.id);
                const unanswered = getUnansweredCount(today, ctx.id);
                const active = activeContext === ctx.id ? 'active' : '';
                return `<div class="chip ${active} ${status}" onclick="selectContext('${ctx.id}')">${unanswered > 0 ? `<span class="progress-badge">${unanswered}</span>` : ''}<span>${ctx.i}</span> ${ctx.l}</div>`;
            }).join('');
        }
        function getContextStatus(date, ctxId) {
            if (history[date]?.some(log => log.ctx === ctxId)) return 'completed';
            if (progress[`${date}_${ctxId}`]) return 'in-progress';
            return '';
        }
        function getUnansweredCount(date, ctxId) {
            const p = progress[`${date}_${ctxId}`];
            if (!p) return 0;
            const ctxQs = getQuestionsForContext(ctxId);
            return Math.max(0, ctxQs.length - Object.keys(p.answers || {}).length);
        }
        function renderWelcomeGrid() {
            const today = getToday();
            const sortedContexts = [...contexts].sort((a, b) => (a.order || 0) - (b.order || 0));
            document.getElementById('welcomeGrid').innerHTML = sortedContexts.map(ctx => {
                const status = getContextStatus(today, ctx.id);
                const btnStatus = status === 'completed' ? '‚úì done' : (status === 'in-progress' ? '‚Üª resume' : '‚Üí start');
                const disabled = status === 'completed' ? 'disabled' : '';
                return `<button class="ctx-btn" ${disabled} onclick="selectContext('${ctx.id}')"><span>${ctx.i}</span> ${ctx.l}<small>${btnStatus}</small></button>`;
            }).join('');
        }

        // ---------- LOGGER ----------
        function selectContext(ctxId) {
            activeContext = ctxId;
            const ctx = contexts.find(c => c.id === ctxId);
            document.getElementById('ctxIcon').innerText = ctx.i;
            document.getElementById('ctxName').innerText = ctx.l;
            const today = getToday();
            const key = `${today}_${ctxId}`;
            const saved = progress[key];
            answers = saved?.answers ? {...saved.answers} : {};
            currentQIndex = saved?.currentQuestionIndex || 0;
            document.getElementById('ctxStatus').innerText = saved ? 'in progress' : 'new';
            document.getElementById('resumeBanner').style.display = (saved && currentQIndex > 0) ? 'block' : 'none';
            renderQuestion(); showView('logger'); renderChips();
        }
        function fastStart() {
            const h = new Date().getHours();
            let id = h < 12 ? 'morn' : (h < 17 ? 'aft' : 'eve');
            if (!contexts.find(c => c.id === id)) id = contexts[0]?.id;
            selectContext(id);
        }
        function renderQuestion() {
            const filtered = getQuestionsForContext(activeContext);
            if (currentQIndex >= filtered.length) { completeContext(); return; }
            const q = filtered[currentQIndex];
            document.getElementById('questionText').innerText = q.l;
            document.getElementById('stepText').innerText = `${currentQIndex+1}/${filtered.length}`;
            document.getElementById('progressFill').style.width = `${((currentQIndex+1)/filtered.length)*100}%`;
            const area = document.getElementById('inputArea');
            area.innerHTML = '';
            const val = answers[q.id] !== undefined ? answers[q.id] : q.d;

            if (q.t === 'time') {
                const inp = document.createElement('input'); inp.type = 'time'; inp.id = 'currentInput'; inp.value = val || ''; area.appendChild(inp);
            } else if (q.t === 'range') {
                const num = parseFloat(val) || 0;
                const container = document.createElement('div');
                const display = document.createElement('div'); display.className = 'range-display'; display.id = 'rangeDisplay'; display.innerText = num.toFixed(1);
                const slider = document.createElement('input'); slider.type = 'range'; slider.id = 'currentInput'; slider.min = '0'; slider.max = '10'; slider.step = '0.5'; slider.value = num;
                slider.oninput = (e) => { display.innerText = parseFloat(e.target.value).toFixed(1); };
                container.appendChild(display); container.appendChild(slider); area.appendChild(container);
            } else if (q.t === 'toggle') {
                const label = document.createElement('label'); label.className = 'switch';
                label.innerHTML = `<input type="checkbox" id="currentInput" ${val ? 'checked' : ''}><span class="slider"></span>`;
                area.appendChild(label);
            } else if (q.t === 'select' || q.t === 'multi') {
                const options = (q.o || '').split(',').map(s => s.trim()).filter(s => s);
                options.forEach(opt => {
                    const pill = document.createElement('div'); pill.className = 'option-pill'; pill.innerText = opt;
                    if (q.t === 'select' && val === opt) pill.classList.add('active');
                    if (q.t === 'multi' && Array.isArray(val) && val.includes(opt)) pill.classList.add('active');
                    pill.onclick = () => {
                        if (q.t === 'select') {
                            answers[q.id] = opt; document.querySelectorAll('.option-pill').forEach(p => p.classList.remove('active')); pill.classList.add('active');
                        } else {
                            if (!Array.isArray(answers[q.id])) answers[q.id] = [];
                            const idx = answers[q.id].indexOf(opt);
                            if (idx > -1) answers[q.id].splice(idx, 1); else answers[q.id].push(opt);
                            pill.classList.toggle('active');
                        }
                        saveProgress();
                    };
                    area.appendChild(pill);
                });
            } else if (q.t === 'textarea') {
                const ta = document.createElement('textarea'); ta.id = 'currentInput'; ta.placeholder = 'type...'; ta.value = val || ''; area.appendChild(ta);
            } else {
                const inp = document.createElement('input'); inp.type = 'text'; inp.id = 'currentInput'; inp.placeholder = 'type...'; inp.value = val || ''; area.appendChild(inp);
            }
            document.getElementById('backBtn').disabled = currentQIndex === 0;
        }
        function captureCurrent() {
            const inp = document.getElementById('currentInput');
            if (!inp) return;
            const filtered = getQuestionsForContext(activeContext);
            if (currentQIndex >= filtered.length) return;
            const q = filtered[currentQIndex];
            if (q.t === 'toggle') answers[q.id] = inp.checked;
            else if (q.t === 'range') answers[q.id] = parseFloat(inp.value).toFixed(1);
            else if (q.t === 'select' || q.t === 'multi') {}
            else answers[q.id] = inp.value.trim();
        }
        function saveProgress() {
            const today = getToday();
            progress[`${today}_${activeContext}`] = { currentQuestionIndex: currentQIndex, answers: {...answers} };
            localStorage.setItem(STORAGE.PROGRESS, JSON.stringify(progress));
            renderChips();
        }
        function handleSkip() { captureCurrent(); saveProgress(); moveNext(); }
        function handleNext() { captureCurrent(); saveProgress(); moveNext(); }
        function moveNext() {
            const filtered = getQuestionsForContext(activeContext);
            if (currentQIndex < filtered.length - 1) { currentQIndex++; renderQuestion(); } else { completeContext(); }
        }
        function handleBack() { captureCurrent(); saveProgress(); if (currentQIndex > 0) { currentQIndex--; renderQuestion(); } }
        function resumeProgress() { document.getElementById('resumeBanner').style.display = 'none'; renderQuestion(); }
        function resetProgress() {
            const today = getToday(); delete progress[`${today}_${activeContext}`]; localStorage.setItem(STORAGE.PROGRESS, JSON.stringify(progress));
            answers = {}; currentQIndex = 0; document.getElementById('resumeBanner').style.display = 'none'; document.getElementById('ctxStatus').innerText = 'new';
            renderQuestion(); renderChips();
        }
        function completeContext() {
            const today = getToday(); const time = new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
            if (!history[today]) history[today] = [];
            history[today].push({ ctx: activeContext, time, ans: {...answers} });
            localStorage.setItem(STORAGE.HISTORY, JSON.stringify(history));
            delete progress[`${today}_${activeContext}`]; localStorage.setItem(STORAGE.PROGRESS, JSON.stringify(progress));
            showSummary();
        }
        function showSummary() {
            const today = getToday(); const logs = history[today] || [];
            let html = '';
            logs.forEach(log => {
                const ctx = contexts.find(c => c.id === log.ctx) || { l: log.ctx };
                html += `<div style="background:#f5f5f7; padding:16px; border-radius:16px; margin-bottom:16px;">`;
                html += `<div style="font-weight:600; margin-bottom:12px;">${ctx.i} ${ctx.l} ¬∑ ${log.time}</div>`;
                Object.entries(log.ans).forEach(([qId, val]) => {
                    const q = bank.find(q => q.id === qId); if (!q) return;
                    const display = Array.isArray(val) ? val.join(', ') : (q.t==='toggle' ? (val ? 'yes' : 'no') : val);
                    html += `<div class="summary-item"><div class="summary-label">${q.l}</div><div class="summary-value">${display}</div></div>`;
                });
                html += '</div>';
            });
            document.getElementById('summaryContent').innerHTML = html; showView('summary'); renderChips();
        }

        // ---------- HISTORY ----------
        function renderCalendar() {
            const today = getToday(); const [y,m] = today.split('-');
            const daysInMonth = new Date(parseInt(y), parseInt(m), 0).getDate(); const firstDay = new Date(parseInt(y), parseInt(m)-1, 1).getDay();
            let html = ''; const dow = ['S','M','T','W','T','F','S']; dow.forEach(d => html += `<div style="text-align:center; font-size:12px;">${d}</div>`);
            for (let i=0; i<firstDay; i++) html += '<div></div>';
            for (let d=1; d<=daysInMonth; d++) {
                const dateStr = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const hasData = history[dateStr]?.length > 0 ? 'has-data' : ''; const isToday = dateStr === today ? 'today' : '';
                html += `<div class="cal-day ${hasData} ${isToday}" onclick="viewDay('${dateStr}')">${d}</div>`;
            }
            document.getElementById('calendar').innerHTML = html; document.getElementById('historyEntries').innerHTML = ''; document.getElementById('dayDownloadBtn').style.display = 'none';
        }
        function viewDay(date) {
            currentViewedDate = date; const logs = history[date] || []; const entries = document.getElementById('historyEntries');
            if (logs.length === 0) { entries.innerHTML = '<div style="text-align:center; padding:40px; color:#86868b;">no entries</div>'; document.getElementById('dayDownloadBtn').style.display = 'none'; return; }
            let html = '';
            logs.forEach((log, idx) => {
                const ctx = contexts.find(c => c.id === log.ctx) || { l: log.ctx, i: 'üìå' };
                html += `<div class="history-entry"><button class="entry-delete" onclick="deleteEntry('${date}', ${idx})">‚úï</button>`;
                html += `<div class="entry-header"><span>${ctx.i} ${ctx.l}</span><span>${log.time}</span></div>`;
                Object.entries(log.ans).forEach(([qId, val]) => {
                    const q = bank.find(q => q.id === qId); if (!q) return;
                    const display = Array.isArray(val) ? val.join(', ') : (q.t==='toggle' ? (val ? 'yes' : 'no') : val);
                    html += `<div class="entry-answer"><strong>${q.l}</strong> ${display}</div>`;
                });
                html += '</div>';
            });
            entries.innerHTML = html; document.getElementById('dayDownloadBtn').style.display = 'block';
        }
        function deleteEntry(date, index) {
            modal.show('Delete', 'Remove this entry?', () => {
                history[date].splice(index, 1); if (history[date].length === 0) delete history[date];
                localStorage.setItem(STORAGE.HISTORY, JSON.stringify(history));
                if (currentViewedDate === date) viewDay(date); renderCalendar(); renderChips();
            });
        }
        function searchHistory() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const entries = document.getElementById('historyEntries'); document.getElementById('dayDownloadBtn').style.display = 'none';
            if (!term) { renderCalendar(); return; }
            document.getElementById('calendar').innerHTML = '';
            let results = [];
            Object.keys(history).forEach(date => {
                history[date].forEach((log, idx) => {
                    const ctx = contexts.find(c => c.id === log.ctx); const ctxName = ctx ? ctx.l.toLowerCase() : '';
                    const ansText = JSON.stringify(log.ans).toLowerCase();
                    if (ctxName.includes(term) || ansText.includes(term) || date.includes(term)) { results.push({date, log, idx}); }
                });
            });
            if (results.length === 0) { entries.innerHTML = '<div style="text-align:center; padding:40px;">no matches</div>'; return; }
            let html = '';
            results.forEach(r => {
                const ctx = contexts.find(c => c.id === r.log.ctx) || { l: r.log.ctx, i: 'üìå' };
                html += `<div class="history-entry"><div class="entry-header"><span>${r.date} ¬∑ ${ctx.i} ${ctx.l}</span><span>${r.log.time}</span></div>`;
                Object.entries(r.log.ans).forEach(([qId, val]) => {
                    const q = bank.find(q => q.id === qId); if (!q) return;
                    const display = Array.isArray(val) ? val.join(', ') : (q.t==='toggle' ? (val ? 'yes' : 'no') : val);
                    html += `<div class="entry-answer"><strong>${q.l}</strong> ${display}</div>`;
                });
                html += '</div>';
            });
            entries.innerHTML = html;
        }

        // ---------- BACKUP & RESTORE (NEW) ----------
        function exportBackup() {
            const backup = {
                contexts: contexts, bank: bank, assignments: assignments,
                history: history, settings: settings, version: 'skeleton_v3',
                timestamp: new Date().toISOString()
            };
            const dataStr = JSON.stringify(backup, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `skeleton_backup_${getToday()}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }

        function importBackup(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.contexts || !data.bank) throw new Error('Invalid backup file');
                    modal.show('Restore Data', 'This will overwrite your current settings and history. Continue?', () => {
                        localStorage.setItem(STORAGE.CONTEXTS, JSON.stringify(data.contexts));
                        localStorage.setItem(STORAGE.BANK, JSON.stringify(data.bank));
                        localStorage.setItem(STORAGE.ASSIGNMENTS, JSON.stringify(data.assignments));
                        localStorage.setItem(STORAGE.HISTORY, JSON.stringify(data.history || {}));
                        localStorage.setItem(STORAGE.SETTINGS, JSON.stringify(data.settings || DEFAULT_SETTINGS));
                        location.reload();
                    });
                } catch (err) { alert('Error loading backup: ' + err.message); }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function hardReset() {
            modal.show('Factory Reset', 'This will delete ALL history and custom prompts. Cannot be undone.', () => {
                localStorage.clear(); location.reload();
            });
        }

        // ---------- DOWNLOAD TXT ----------
        function downloadDay(date) {
            const logs = history[date]; if (!logs || logs.length === 0) { alert('no logs for this day'); return; }
            let content = `SKELETON LOG ¬∑ ${date}\n==================\n\n`;
            const groups = {}; logs.forEach(log => { if (!groups[log.ctx]) groups[log.ctx] = []; groups[log.ctx].push(log); });
            Object.entries(groups).forEach(([ctxId, ctxLogs]) => {
                const ctx = contexts.find(c => c.id === ctxId) || { l: ctxId, i: '?' };
                content += `\n${ctx.i} ${ctx.l.toUpperCase()}\n${'-'.repeat(ctx.l.length + 4)}\n`;
                ctxLogs.forEach((log, i) => {
                    content += `\n[${i+1}] ${log.time}\n`;
                    Object.entries(log.ans).forEach(([qId, val]) => {
                        const q = bank.find(q => q.id === qId); if (!q) return;
                        let display = val; if (Array.isArray(val)) display = val.join(', '); else if (q.t === 'toggle') display = val ? 'yes' : 'no'; else if (q.t === 'range') display = parseFloat(val).toFixed(1);
                        content += ` ‚Ä¢ ${q.l}: ${display}\n`;
                    });
                });
                content += '\n';
            });
            const blob = new Blob([content], { type: 'text/plain' }); const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `skeleton_${date}.txt`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }
        function downloadCurrentDay() { if (currentViewedDate) downloadDay(currentViewedDate); }
        function downloadToday() { downloadDay(getToday()); }

        // ---------- EDITOR ----------
        function renderEditor() {
            Object.keys(settings.sections).forEach(section => {
                const content = document.getElementById(section + 'Section'); const toggle = document.getElementById(section + 'Toggle');
                if (content && toggle) {
                    if (settings.sections[section]) { content.classList.remove('collapsed'); toggle.innerText = '‚ñº'; }
                    else { content.classList.add('collapsed'); toggle.innerText = '‚ñ∂'; }
                }
            });
            renderContextEditor(); renderBankEditor(); renderAssignmentEditor(); setTimeout(addBlurListeners, 100);
        }
        function renderContextEditor() {
            const sortedContexts = [...contexts].sort((a, b) => (a.order || 0) - (b.order || 0));
            let ctxHtml = '';
            sortedContexts.forEach((ctx, i) => {
                ctxHtml += `<div class="context-item"><div style="display:flex; gap:10px; margin-bottom:10px;"><input value="${escapeHtml(ctx.i)}" id="ctx-icon-${ctx.id}" style="width:50px; text-align:center;" onblur="triggerAutoSave()"><input value="${escapeHtml(ctx.l)}" id="ctx-label-${ctx.id}" style="flex:1;" placeholder="context name" onblur="triggerAutoSave()"></div><div class="reorder-controls"><button class="icon-btn" style="width:36px; height:36px;" onclick="moveContext('${ctx.id}', -1)" ${i===0?'disabled':''}>‚Üë</button><button class="icon-btn" style="width:36px; height:36px;" onclick="moveContext('${ctx.id}', 1)" ${i===sortedContexts.length-1?'disabled':''}>‚Üì</button><button class="icon-btn" style="width:36px; height:36px; background:#ff3b30; color:white;" onclick="deleteContext('${ctx.id}')">‚úï</button></div></div>`;
            });
            document.getElementById('contextEditor').innerHTML = ctxHtml;
        }
        function onBankTypeChange(qId, selectEl) {
            const optionsDiv = document.getElementById(`bank-options-${qId}`);
            if (selectEl.value === 'select' || selectEl.value === 'multi') { optionsDiv.style.display = 'block'; } else { optionsDiv.style.display = 'none'; }
            triggerAutoSave();
        }
        function renderBankEditor() {
            const sortedBank = [...bank].sort((a, b) => (b.created || 0) - (a.created || 0));
            let bankHtml = '';
            sortedBank.forEach(q => {
                const usedIn = Object.entries(assignments).filter(([ctxId, qIds]) => qIds.includes(q.id)).map(([ctxId]) => contexts.find(c => c.id === ctxId)?.l || ctxId);
                bankHtml += `<div class="bank-item"><div class="bank-header"><span class="bank-title">${escapeHtml(q.l)}</span><span class="badge">${usedIn.length} context${usedIn.length !== 1 ? 's' : ''}</span></div><div style="margin-bottom:10px;"><select id="bank-type-${q.id}" style="width:100%; margin-bottom:8px;" onchange="onBankTypeChange('${q.id}', this)"><option value="text" ${q.t==='text'?'selected':''}>text</option><option value="textarea" ${q.t==='textarea'?'selected':''}>long text</option><option value="time" ${q.t==='time'?'selected':''}>time</option><option value="range" ${q.t==='range'?'selected':''}>range</option><option value="toggle" ${q.t==='toggle'?'selected':''}>yes/no</option><option value="select" ${q.t==='select'?'selected':''}>pick one</option><option value="multi" ${q.t==='multi'?'selected':''}>pick many</option></select><input type="text" id="bank-options-${q.id}" placeholder="options (comma separated)" value="${escapeHtml(q.o || '')}" style="width:100%; ${q.t!=='select' && q.t!=='multi' ? 'display:none;' : ''}" onblur="triggerAutoSave()"></div>${usedIn.length > 0 ? `<div class="bank-tags">${usedIn.map(ctxName => `<span class="context-tag">${ctxName}</span>`).join('')}</div>` : ''}<div style="display:flex; gap:6px; margin-top:10px;"><button class="icon-btn" style="flex:1; background:#ff3b30; color:white;" onclick="deleteFromBank('${q.id}')">delete</button></div></div>`;
            });
            bankHtml += `<div class="bank-item" style="border-left-color: #34c759;"><div style="font-weight:500; margin-bottom:12px;">‚ûï create new question</div><input type="text" id="newBankQuestion" placeholder="question text" style="margin-bottom:10px;"><select id="newBankType" style="width:100%; margin-bottom:10px;" onchange="document.getElementById('newBankOptions').style.display = this.value==='select'||this.value==='multi'?'block':'none'"><option value="text">text</option><option value="textarea">long text</option><option value="time">time</option><option value="range">range</option><option value="toggle">yes/no</option><option value="select">pick one</option><option value="multi">pick many</option></select><input type="text" id="newBankOptions" placeholder="options (comma separated)" style="width:100%; display:none;"><button class="download-btn" style="margin:8px 0 0;" onclick="addToBankFromForm()">save to bank</button></div>`;
            document.getElementById('bankEditor').innerHTML = bankHtml;
        }
        function renderAssignmentEditor() {
            const sortedContexts = [...contexts].sort((a, b) => (a.order || 0) - (b.order || 0));
            let assignHtml = '';
            sortedContexts.forEach(ctx => {
                const assignedIds = assignments[ctx.id] || [];
                const assignedQuestions = assignedIds.map(id => bank.find(q => q.id === id)).filter(q => q);
                assignHtml += `<div class="context-item" style="margin-bottom:20px;"><div style="font-weight:600; margin-bottom:12px;">${ctx.i} ${ctx.l}</div>`;
                if (assignedQuestions.length > 0) {
                    assignHtml += `<div style="margin-bottom:12px;">`;
                    assignedQuestions.forEach((q, idx) => {
                        const isSelected = (selectedAssignmentContext === ctx.id && selectedAssignmentIndex === idx);
                        assignHtml += `<div class="assigned-item ${isSelected ? 'selected' : ''}" onclick="selectAssignment('${ctx.id}', ${idx})"><span class="assigned-order">${idx + 1}</span><span class="assigned-text">${escapeHtml(q.l)}</span><button class="icon-btn" style="width:32px; height:32px; background:none;" onclick="event.stopPropagation(); removeFromContext('${ctx.id}', '${q.id}')">‚úï</button></div>`;
                    });
                    assignHtml += `</div>`;
                    if (selectedAssignmentContext === ctx.id && selectedAssignmentIndex !== -1) {
                        assignHtml += `<div class="reorder-controls" style="margin-bottom:12px; justify-content:center;"><button class="icon-btn" style="width:44px;" onclick="moveSelectedUp('${ctx.id}')" ${selectedAssignmentIndex === 0 ? 'disabled' : ''}>‚Üë</button><button class="icon-btn" style="width:44px;" onclick="moveSelectedDown('${ctx.id}')" ${selectedAssignmentIndex === assignedQuestions.length - 1 ? 'disabled' : ''}>‚Üì</button><button class="icon-btn" style="width:44px; background:#007aff; color:white;" onclick="clearSelection()">‚úì</button></div>`;
                    }
                } else { assignHtml += `<p style="color:#86868b; margin-bottom:12px;">no questions assigned</p>`; }
                const availableQuestions = bank.filter(q => !assignedIds.includes(q.id));
                if (availableQuestions.length > 0) {
                    assignHtml += `<select id="addTo-${ctx.id}" class="context-selector" style="margin-bottom:8px;"><option value="">select question to add...</option>${availableQuestions.map(q => `<option value="${q.id}">${escapeHtml(q.l)}</option>`).join('')}</select><button class="download-btn" style="margin:0;" onclick="addToContext('${ctx.id}')">+ add to ${ctx.l}</button>`;
                }
                assignHtml += `</div>`;
            });
            document.getElementById('assignmentEditor').innerHTML = assignHtml;
        }

        // ---------- CONTROLLERS ----------
        function selectAssignment(ctxId, index) { if (selectedAssignmentContext === ctxId && selectedAssignmentIndex === index) { selectedAssignmentContext = null; selectedAssignmentIndex = -1; } else { selectedAssignmentContext = ctxId; selectedAssignmentIndex = index; } renderAssignmentEditor(); }
        function clearSelection() { selectedAssignmentContext = null; selectedAssignmentIndex = -1; renderAssignmentEditor(); }
        function moveSelectedUp(ctxId) { if (selectedAssignmentContext !== ctxId || selectedAssignmentIndex <= 0) return; const ids = assignments[ctxId] || []; const temp = ids[selectedAssignmentIndex]; ids[selectedAssignmentIndex] = ids[selectedAssignmentIndex - 1]; ids[selectedAssignmentIndex - 1] = temp; assignments[ctxId] = ids; selectedAssignmentIndex--; triggerAutoSave(); renderAssignmentEditor(); }
        function moveSelectedDown(ctxId) { if (selectedAssignmentContext !== ctxId) return; const ids = assignments[ctxId] || []; if (selectedAssignmentIndex >= ids.length - 1) return; const temp = ids[selectedAssignmentIndex]; ids[selectedAssignmentIndex] = ids[selectedAssignmentIndex + 1]; ids[selectedAssignmentIndex + 1] = temp; assignments[ctxId] = ids; selectedAssignmentIndex++; triggerAutoSave(); renderAssignmentEditor(); }
        function addToBank() { document.getElementById('bankSection').classList.remove('collapsed'); document.getElementById('bankToggle').innerText = '‚ñº'; setTimeout(() => { document.getElementById('newBankQuestion').focus(); }, 100); }
        function addToBankFromForm() {
            const text = document.getElementById('newBankQuestion').value.trim(); if (!text) { modal.show('Error', 'Please enter a question'); return; }
            const type = document.getElementById('newBankType').value; const options = document.getElementById('newBankOptions').value;
            const newId = 'q_' + Date.now(); bank.push({ id: newId, l: text, t: type, o: options, d: type === 'toggle' ? false : (type === 'range' ? '5' : ''), created: Date.now() });
            document.getElementById('newBankQuestion').value = ''; document.getElementById('newBankType').value = 'text'; document.getElementById('newBankOptions').value = ''; document.getElementById('newBankOptions').style.display = 'none';
            triggerAutoSave(); renderBankEditor(); renderAssignmentEditor();
        }
        function deleteFromBank(qId) { modal.show('Delete', 'Remove this question from bank?', () => { Object.keys(assignments).forEach(ctxId => { assignments[ctxId] = (assignments[ctxId] || []).filter(id => id !== qId); }); bank = bank.filter(q => q.id !== qId); triggerAutoSave(); renderBankEditor(); renderAssignmentEditor(); }); }
        function addToContext(ctxId) { const select = document.getElementById(`addTo-${ctxId}`); const qId = select.value; if (!qId) return; if (!assignments[ctxId]) assignments[ctxId] = []; assignments[ctxId].push(qId); triggerAutoSave(); renderAssignmentEditor(); }
        function removeFromContext(ctxId, qId) { if (assignments[ctxId]) { assignments[ctxId] = assignments[ctxId].filter(id => id !== qId); if (selectedAssignmentContext === ctxId) { selectedAssignmentContext = null; selectedAssignmentIndex = -1; } triggerAutoSave(); renderAssignmentEditor(); } }
        function syncFromEditor() { contexts.forEach(ctx => { const icon = document.getElementById(`ctx-icon-${ctx.id}`); const label = document.getElementById(`ctx-label-${ctx.id}`); if (icon) ctx.i = icon.value; if (label) ctx.l = label.value; }); bank.forEach(q => { const type = document.getElementById(`bank-type-${q.id}`); const opts = document.getElementById(`bank-options-${q.id}`); if (type) q.t = type.value; if (opts) q.o = opts.value; }); }
        function moveContext(ctxId, direction) { syncFromEditor(); const index = contexts.findIndex(c => c.id === ctxId); const target = index + direction; if (target < 0 || target >= contexts.length) return; const tempOrder = contexts[index].order; contexts[index].order = contexts[target].order; contexts[target].order = tempOrder; contexts.sort((a, b) => (a.order || 0) - (b.order || 0)); triggerAutoSave(); renderEditor(); renderChips(); renderWelcomeGrid(); }
        function addContext() { syncFromEditor(); const newOrder = contexts.length; const newId = 'ctx_' + Date.now(); contexts.push({ id: newId, l: 'new context', i: 'üìå', order: newOrder }); assignments[newId] = []; triggerAutoSave(); renderEditor(); renderChips(); renderWelcomeGrid(); }
        function deleteContext(ctxId) { const ctx = contexts.find(c => c.id === ctxId); modal.show('Delete', `Remove "${ctx.l}"? Questions in bank will be preserved.`, () => { contexts = contexts.filter(c => c.id !== ctxId); delete assignments[ctxId]; contexts.forEach((c, idx) => { c.order = idx; }); if (selectedAssignmentContext === ctxId) { selectedAssignmentContext = null; selectedAssignmentIndex = -1; } triggerAutoSave(); renderEditor(); renderChips(); renderWelcomeGrid(); if (activeContext === ctxId) { activeContext = ''; showView('welcome'); } }); }
        function saveConfig() { if (autoSaveTimer) clearTimeout(autoSaveTimer); syncFromEditor(); localStorage.setItem(STORAGE.CONTEXTS, JSON.stringify(contexts)); localStorage.setItem(STORAGE.BANK, JSON.stringify(bank)); localStorage.setItem(STORAGE.ASSIGNMENTS, JSON.stringify(assignments)); pendingChanges = false; document.getElementById('autoSaveIndicator').innerText = '‚úì all changes saved'; modal.show('Saved', 'Settings saved', () => location.reload()); }

        // ---------- INIT ----------
        window.onload = () => {
            modal.init();
            contexts.forEach(ctx => { if (!assignments[ctx.id]) assignments[ctx.id] = []; });
            contexts.forEach((ctx, idx) => { if (ctx.order === undefined) ctx.order = idx; });
            renderChips(); renderWelcomeGrid(); showView('welcome');
        };

        // EXPOSE GLOBALS
        window.showView = showView; window.selectContext = selectContext; window.fastStart = fastStart; window.handleNext = handleNext; window.handleSkip = handleSkip; window.handleBack = handleBack; window.resumeProgress = resumeProgress; window.resetProgress = resetProgress; window.viewDay = viewDay; window.searchHistory = searchHistory; window.deleteEntry = deleteEntry; window.downloadCurrentDay = downloadCurrentDay; window.downloadToday = downloadToday; window.toggleSection = toggleSection; window.addContext = addContext; window.addToBank = addToBank; window.addToBankFromForm = addToBankFromForm; window.deleteFromBank = deleteFromBank; window.addToContext = addToContext; window.removeFromContext = removeFromContext; window.selectAssignment = selectAssignment; window.clearSelection = clearSelection; window.moveSelectedUp = moveSelectedUp; window.moveSelectedDown = moveSelectedDown; window.onBankTypeChange = onBankTypeChange; window.moveContext = moveContext; window.deleteContext = deleteContext; window.saveConfig = saveConfig; window.triggerAutoSave = triggerAutoSave; window.modal = modal; window.exportBackup = exportBackup; window.importBackup = importBackup; window.hardReset = hardReset;
    </script>
</body>
</html>
