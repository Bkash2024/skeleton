<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Skeleton Logger</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        :root { 
            --p: #6366f1; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --sub: #64748b; 
            --err: #ef4444; --border: #e2e8f0; --accent: #f1f5f9;
        }

        @media (prefers-color-scheme: dark) {
            :root:not(.light-mode) {
                --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --sub: #94a3b8; 
                --border: #334155; --accent: #0f172a;
            }
        }
        
        .dark-mode { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --sub: #94a3b8; --border: #334155; --accent: #0f172a; }
        .light-mode { --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --sub: #64748b; --border: #e2e8f0; --accent: #f1f5f9; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh; padding-top: env(safe-area-inset-top); transition: background 0.3s ease; }
        .wrap { width: 100%; max-width: 500px; }
        header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; }
        h1 { margin: 0; font-size: 24px; letter-spacing: -1px; }
        
        .chip-grid { display: flex; overflow-x: auto; gap: 8px; margin-bottom: 20px; padding-bottom: 10px; scrollbar-width: none; }
        .chip-grid::-webkit-scrollbar { display: none; }
        .chip { flex: 0 0 85px; background: var(--card); border: 1px solid var(--border); padding: 12px 4px; border-radius: 18px; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; transition: 0.2s; }
        .chip span:first-child { font-size: 20px; }
        .chip span:last-child { font-size: 9px; font-weight: 800; text-transform: uppercase; color: var(--sub); text-align: center; }
        .chip.active { border-color: var(--p); background: rgba(99,102,241,0.1); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(99,102,241,0.1); }
        
        .card { background: var(--card); border-radius: 32px; box-shadow: 0 15px 35px -10px rgba(0,0,0,0.1); padding: 25px; min-height: 480px; display: flex; flex-direction: column; position: relative; overflow: hidden; border: 1px solid var(--border); }
        .prog { position: absolute; top: 0; left: 0; height: 5px; background: var(--border); width: 100%; }
        .prog-fill { height: 100%; background: var(--p); transition: 0.4s ease; }
        
        .q-label { font-size: 22px; font-weight: 800; line-height: 1.2; margin-bottom: 20px; color: var(--text); width: 100%; }
        .input-area { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; overflow-y: auto; }
        
        input[type=time], input[type=number], input[type=text], input[type=search] { border: none; border-bottom: 2px solid var(--border); font-size: 24px; font-weight: 800; width: 100%; text-align: center; outline: none; background: transparent; padding: 12px; color: var(--text); border-radius: 0; }
        input[type=search] { font-size: 14px; text-align: left; padding: 10px 16px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 15px; background: var(--card); }
        
        .option-container { display: flex; flex-direction: column; gap: 8px; width: 100%; padding: 5px 0; }
        .opt-pill { background: var(--accent); padding: 12px 18px; border-radius: 16px; cursor: pointer; border: 2px solid transparent; font-weight: 700; width: 100%; text-align: center; transition: 0.2s; color: var(--text); font-size: 15px; }
        .opt-pill.active { border-color: var(--p); background: rgba(99,102,241,0.1); color: var(--p); transform: scale(1.01); }

        .switch { position: relative; display: inline-block; width: 56px; height: 32px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--p); }
        input:checked + .slider:before { transform: translateX(24px); }
        
        .controls { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; gap: 10px; width: 100%; }
        button { border-radius: 16px; font-weight: 700; cursor: pointer; transition: 0.2s; border: none; font-family: inherit; }
        .btn-p { background: var(--p); color: #fff; padding: 14px 28px; font-size: 16px; box-shadow: 0 4px 10px rgba(99,102,241,0.2); }
        .btn-sec { background: none; color: var(--sub); font-size: 15px; padding: 12px; }
        .btn-skip { background: var(--accent); color: var(--sub); padding: 14px 20px; font-size: 14px; }
        .hidden { display: none !important; }
        
        .history-card { background: var(--accent); border: 1px solid var(--border); border-radius: 20px; padding: 16px; margin-bottom: 12px; position: relative; }
        .edit-row { background: var(--accent); border-radius: 18px; padding: 18px; margin-bottom: 12px; border: 1px solid var(--border); }
        .ctx-pill { font-size: 9px; font-weight: 800; padding: 6px 10px; border-radius: 8px; border: 1px solid var(--border); margin: 0 5px 5px 0; background: var(--card); color: var(--sub); display: inline-block; cursor: pointer; }
        .ctx-pill.on { background: var(--p); color: white; border-color: var(--p); }
        
        .scroll { max-height: 420px; overflow-y: auto; padding-right: 5px; -webkit-overflow-scrolling: touch; }
        .cal { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .cal-d { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 12px; background: var(--card); border: 1px solid var(--border); border-radius: 10px; font-weight: 600; cursor: pointer; }
        .cal-d.has { background: rgba(99,102,241,0.1); color: var(--p); font-weight: 900; border-color: var(--p); }
        .cal-d.today { border: 2px solid #fbbf24; }
        
        .order-btn { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 6px 10px; font-size: 12px; color: var(--sub); font-weight: 900; }

        footer { margin-top: 25px; color: var(--sub); font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.8; text-align: center; }
        
        #customModal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; backdrop-filter: blur(2px); }
        .modal-card { background: var(--card); border-radius: 24px; padding: 25px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div class="wrap">
        <header>
            <div><h1>ü¶¥ Skeleton</h1><small id="timeStatus">V 1.5.3 ‚Ä¢ Fully Functional</small></div>
            <div style="display:flex; gap:8px;">
                <button class="btn-sec" onclick="showView('history')">üìÖ</button>
                <button class="btn-sec" onclick="showView('setup')">‚öôÔ∏è</button>
            </div>
        </header>

        <div class="chip-grid" id="ctxGrid"></div>

        <main class="card">
            <div id="welcomeView">
                <div style="text-align:center; padding: 50px 0;">
                    <div style="font-size: 60px; margin-bottom: 20px;">ü¶¥</div>
                    <h2 style="margin:0 0 10px 0; font-size: 26px;">Daily Skeleton</h2>
                    <p style="color:var(--sub); font-size:15px; margin-bottom:35px; line-height:1.5;">Fact-based logging.<br>Select a context to begin.</p>
                    <button class="btn-p" onclick="fastStart()">Auto-Detect Context</button>
                </div>
            </div>

            <div id="loggerView" class="hidden">
                <div class="prog"><div class="prog-fill" id="progBar"></div></div>
                <div style="font-size:11px; font-weight:900; color:var(--p); margin-bottom:12px; letter-spacing:1px;" id="qCat">CONTEXT</div>
                <div class="q-label" id="qLab">Question?</div>
                <div class="input-area" id="qInp"></div>
                <div class="controls">
                    <button class="btn-sec" id="backBtn">Back</button>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-skip" id="skipBtn">Skip</button>
                        <button class="btn-p" id="nextBtn">Next</button>
                    </div>
                </div>
                <div style="text-align:center; margin-top:20px;"><small id="step" style="font-size:11px; font-weight:900; color:#cbd5e1;">1 / 1</small></div>
            </div>

            <div id="historyView" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <b style="font-size:12px; letter-spacing:1px; color:var(--sub);">HISTORY ARCHIVE</b>
                    <button class="btn-sec" onclick="showView('welcome')">‚úï</button>
                </div>
                <input type="search" id="historySearch" placeholder="Search entries..." oninput="renderHistoryList()">
                <div class="cal" id="calContainer" style="margin-bottom: 20px;"></div>
                <div id="dayDetail" class="scroll"></div>
            </div>

            <div id="setupView" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <b style="font-size:12px; letter-spacing:1px; color:var(--sub);">EDITORIAL CONFIG</b>
                    <button class="btn-sec" onclick="showView('welcome')">‚úï</button>
                </div>
                <div class="scroll">
                    <div id="ctxEditList"></div>
                    <div id="qEditList"></div>
                </div>
                <button class="btn-p" style="width:100%; margin-top:20px;" onclick="saveConfig()">Save All Changes</button>
            </div>

            <div id="summaryView" class="hidden" style="text-align:center;">
                <div style="font-size:50px; margin-bottom:20px;">‚ú®</div>
                <h2 style="margin-bottom:10px;">Logged Successfully</h2>
                <div id="summList" class="scroll" style="text-align:left; margin-bottom:25px;"></div>
                <button class="btn-p" style="width:100%" id="dlToday">Download .txt</button>
            </div>
        </main>
        <footer>V 1.5.3 ‚Ä¢ OPTIONS & ORDER</footer>
    </div>

    <div id="customModal" class="hidden">
        <div class="modal-card">
            <h3 id="modalTitle">Notice</h3>
            <p id="modalBody" style="color:var(--sub); font-size:14px; line-height:1.5;"></p>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                <button class="btn-skip" id="modalCancel">Cancel</button>
                <button class="btn-p" id="modalConfirm">OK</button>
            </div>
        </div>
    </div>

    <script>
        const getLocalDay = (dateObj = new Date()) => {
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const DEFAULT_CTX = [{id:'morning',l:'Morning',i:'üåÖ'}, {id:'afternoon',l:'Afternoon',i:'‚òÄÔ∏è'}, {id:'evening',l:'Evening',i:'üåô'}];
        const DEFAULT_Q = [
            {id:'q1', c:['morning'], l:'Mood today?', t:'select', o:'Excellent,Good,Neutral,Tired', d:'Good'},
            {id:'q2', c:['morning'], l:'Daily Tasks', t:'multi', o:'Work,Exercise,Reading,Cleaning', d:[]},
            {id:'q3', c:['morning','afternoon','evening'], l:'Water Intake (L)', t:'range', d:'1.5'}
        ];

        let contexts = JSON.parse(localStorage.getItem('skel_ctx_v7') || JSON.stringify(DEFAULT_CTX));
        let questions = JSON.parse(localStorage.getItem('skel_q_v7') || JSON.stringify(DEFAULT_Q));
        let history = JSON.parse(localStorage.getItem('skel_h_v7') || '{}');
        
        let filtered = [], cur = 0, answers = {}, activeCtx = '';

        function init() {
            renderChips();
            document.getElementById('nextBtn').onclick = handleNext;
            document.getElementById('skipBtn').onclick = handleSkip;
            document.getElementById('backBtn').onclick = handleBack;
            document.getElementById('dlToday').onclick = () => dlDay(getLocalDay());
        }

        function renderChips() {
            document.getElementById('ctxGrid').innerHTML = contexts.map(c => `
                <div class="chip" onclick="selCtx('${c.id}')" id="c-${c.id}">
                    <span>${c.i}</span><span>${c.l}</span>
                </div>
            `).join('');
        }

        function showView(v) {
            ['welcomeView','loggerView','historyView','setupView','summaryView'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(v + 'View').classList.remove('hidden');
            if(v === 'history') renderCal();
            if(v === 'setup') renderEditor();
        }

        function selCtx(id) {
            activeCtx = id;
            filtered = questions.filter(q => q.c.includes(id));
            if(!filtered.length) {
                showModal("Configuration Error", "No prompts found for this context tab.");
                return;
            }
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            const chip = document.getElementById('c-'+id);
            if(chip) chip.classList.add('active');
            cur = 0; answers = {};
            showView('logger');
            renderStep();
        }

        function fastStart() {
            const h = new Date().getHours();
            selCtx(h < 12 ? 'morning' : (h < 17 ? 'afternoon' : 'evening'));
        }

        function renderStep() {
            const q = filtered[cur];
            const ctxObj = contexts.find(c => c.id === activeCtx);
            document.getElementById('qCat').innerText = (ctxObj ? ctxObj.l : activeCtx).toUpperCase();
            document.getElementById('qLab').innerText = q.l;
            document.getElementById('step').innerText = `${cur+1} / ${filtered.length}`;
            document.getElementById('progBar').style.width = `${((cur+1)/filtered.length)*100}%`;
            
            const area = document.getElementById('qInp'); 
            area.innerHTML = '';
            
            let val = answers[q.id];
            if(val === undefined) val = q.d;

            if(q.t==='time') {
                const inp = document.createElement('input');
                inp.type = 'time'; inp.id = `i-${q.id}`; inp.value = val;
                area.appendChild(inp);
            } 
            else if(q.t==='range') {
                const wrap = document.createElement('div');
                wrap.style.width = '100%'; wrap.style.textAlign = 'center';
                wrap.innerHTML = `<div style="font-size:55px; font-weight:900; color:var(--p);" id="rv-${q.id}">${val}</div>`;
                const inp = document.createElement('input');
                inp.type = 'range'; inp.min = '0'; inp.max = '10'; inp.step = '0.5'; inp.id = `i-${q.id}`; inp.value = val;
                inp.oninput = () => document.getElementById(`rv-${q.id}`).innerText = inp.value;
                wrap.appendChild(inp);
                area.appendChild(wrap);
            } 
            else if(q.t==='toggle') {
                const lbl = document.createElement('label'); lbl.className = 'switch';
                lbl.innerHTML = `<input type="checkbox" id="i-${q.id}" ${val ? 'checked' : ''}><span class="slider"></span>`;
                area.appendChild(lbl);
            } 
            else if(q.t==='textarea') {
                const txt = document.createElement('textarea');
                txt.id = `i-${q.id}`;
                txt.style.width = '100%'; txt.style.height = '180px';
                txt.style.border = '1px solid var(--border)'; txt.style.borderRadius = '18px';
                txt.style.padding = '15px'; txt.style.background = 'var(--accent)';
                txt.style.color = 'var(--text)'; txt.style.fontSize = '16px';
                txt.value = val;
                area.appendChild(txt);
            } 
            else if(q.t==='select' || q.t==='multi') {
                const options = (q.o || "").split(',').map(o => o.trim()).filter(o => o);
                const container = document.createElement('div');
                container.className = 'option-container';
                options.forEach(opt => {
                    const pill = document.createElement('div');
                    pill.className = 'opt-pill';
                    const isActive = q.t === 'multi' ? (Array.isArray(val) && val.includes(opt)) : (val === opt);
                    if(isActive) pill.classList.add('active');
                    pill.innerText = opt;
                    pill.onclick = () => toggleOption(q.id, opt, q.t);
                    container.appendChild(pill);
                });
                area.appendChild(container);
            } 
            else {
                const inp = document.createElement('input');
                inp.type = 'text'; inp.id = `i-${q.id}`; inp.value = val; inp.placeholder = "Type here...";
                area.appendChild(inp);
            }
        }

        function toggleOption(qid, opt, type) {
            if(type === 'select') {
                answers[qid] = opt;
            } else {
                if(!Array.isArray(answers[qid])) answers[qid] = [];
                if(answers[qid].includes(opt)) answers[qid] = answers[qid].filter(o => o !== opt);
                else answers[qid].push(opt);
            }
            renderStep();
        }

        function captureCurrent() {
            const q = filtered[cur];
            if(!q) return;
            const el = document.getElementById(`i-${q.id}`);
            if(q.t !== 'select' && q.t !== 'multi') {
                if(!el) return;
                answers[q.id] = q.t === 'toggle' ? el.checked : el.value;
            } else if (answers[q.id] === undefined) {
                answers[q.id] = q.d;
            }
        }

        function handleNext() {
            captureCurrent();
            moveStep();
        }

        function handleSkip() { moveStep(); }

        function moveStep() {
            if(cur < filtered.length - 1) { cur++; renderStep(); }
            else { saveToHistory(); }
        }

        function handleBack() {
            captureCurrent();
            if(cur > 0) { cur--; renderStep(); }
        }

        function saveToHistory() {
            const day = getLocalDay();
            if(!history[day]) history[day] = [];
            history[day].push({ ctx: activeCtx, time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), ans: {...answers} });
            localStorage.setItem('skel_h_v7', JSON.stringify(history));
            showView('summary');
            document.getElementById('summList').innerHTML = filtered.map(q => {
                const ans = answers[q.id];
                if(ans === undefined) return '';
                const displayVal = Array.isArray(ans) ? ans.join(', ') : (q.t === 'toggle' ? (ans ? 'Yes' : 'No') : ans);
                return `<div style="padding:12px 0; border-bottom:1px solid var(--border); font-size:13px;"><b style="color:var(--sub); font-size:9px; text-transform:uppercase;">${q.l}</b><br><span style="font-weight:700;">${displayVal}</span></div>`;
            }).join('');
        }

        function syncUItoState() {
            contexts.forEach((c, i) => {
                const iEl = document.getElementById('ci-'+i);
                const lEl = document.getElementById('cl-'+i);
                if(iEl) c.i = iEl.value;
                if(lEl) c.l = lEl.value;
            });
            questions.forEach((q, i) => {
                const lEl = document.getElementById('ql-'+i);
                const tEl = document.getElementById('qt-'+i);
                const oEl = document.getElementById('qo-'+i);
                if(lEl) q.l = lEl.value;
                if(tEl) q.t = tEl.value;
                if(oEl) q.o = oEl.value;
            });
        }

        function moveCtx(i, dir) {
            syncUItoState();
            const target = i + dir;
            if(target < 0 || target >= contexts.length) return;
            [contexts[i], contexts[target]] = [contexts[target], contexts[i]];
            renderEditor();
        }

        function moveQ(i, dir) {
            syncUItoState();
            const target = i + dir;
            if(target < 0 || target >= questions.length) return;
            [questions[i], questions[target]] = [questions[target], questions[i]];
            renderEditor();
        }

        function renderEditor() {
            document.getElementById('ctxEditList').innerHTML = `<div style="display:flex; justify-content:space-between; margin:20px 0 12px 0;"><b style="font-size:10px; color:var(--sub); letter-spacing:1px;">TABS</b><button onclick="addCtx()" style="color:var(--p); font-size:11px; font-weight:900; background:none;">+ ADD</button></div>` + contexts.map((c, i) => `
                <div class="edit-row"><div style="display:flex; gap:10px; align-items:center;"><input style="width:40px; text-align:center; font-size:22px; border:none; background:transparent;" id="ci-${i}" value="${c.i}"><input style="flex:1; font-weight:800; border:none; background:transparent; font-size:15px; color:var(--text);" id="cl-${i}" value="${c.l}"><div style="display:flex; gap:4px;"><button onclick="moveCtx(${i},-1)" class="order-btn">‚Üê</button><button onclick="moveCtx(${i},1)" class="order-btn">‚Üí</button><button onclick="delCtx(${i})" style="color:var(--err); background:none; font-weight:900; margin-left:8px;">‚úï</button></div></div></div>`).join('');

            document.getElementById('qEditList').innerHTML = `<div style="display:flex; justify-content:space-between; margin:20px 0 12px 0;"><b style="font-size:10px; color:var(--sub); letter-spacing:1px;">PROMPTS</b><button onclick="addQ()" style="color:var(--p); font-size:11px; font-weight:900; background:none;">+ ADD</button></div>` + questions.map((q, i) => `
                <div class="edit-row"><div style="display:flex; justify-content:space-between; margin-bottom:12px;"><input style="width:75%; font-weight:800; border:none; border-bottom:1px solid var(--border); background:transparent; font-size:15px; color:var(--text);" id="ql-${i}" value="${q.l}"><div style="display:flex; gap:4px;"><button onclick="moveQ(${i},-1)" class="order-btn">‚Üë</button><button onclick="moveQ(${i},1)" class="order-btn">‚Üì</button></div></div><div style="margin-bottom:12px; display:flex; flex-wrap:wrap;">${contexts.map(c => `<span class="ctx-pill ${q.c.includes(c.id)?'on':''}" onclick="tglQC(${i},'${c.id}')">${c.i} ${c.l}</span>`).join('')}</div><div style="display:flex; gap:10px; margin-bottom:10px;"><select id="qt-${i}" onchange="syncUItoState(); renderEditor()" style="flex:1; font-size:11px; font-weight:900; background:var(--card); color:var(--text); border:1px solid var(--border); border-radius:8px; padding:6px;"><option value="toggle" ${q.t==='toggle'?'selected':''}>TOGGLE</option><option value="select" ${q.t==='select'?'selected':''}>CHOOSE ONE</option><option value="multi" ${q.t==='multi'?'selected':''}>CHOOSE MANY</option><option value="time" ${q.t==='time'?'selected':''}>TIME</option><option value="range" ${q.t==='range'?'selected':''}>RANGE</option><option value="text" ${q.t==='text'?'selected':''}>TEXT</option><option value="textarea" ${q.t==='textarea'?'selected':''}>LARGE TEXT</option></select><button onclick="delQ(${i})" style="color:var(--err); background:none; font-size:11px; font-weight:900;">DELETE</button></div>${(q.t==='select' || q.t==='multi') ? `<input id="qo-${i}" placeholder="Options: Apple, Banana..." value="${q.o || ''}" style="width:100%; font-size:11px; padding:10px; background:var(--card); border:1px solid var(--border); border-radius:8px; color:var(--text); font-weight:600;">` : ''}</div>`).join('');
        }

        function tglQC(qi, ci) {
            syncUItoState();
            const q = questions[qi];
            if(q.c.includes(ci)) q.c = q.c.filter(id => id !== ci);
            else q.c.push(ci);
            renderEditor();
        }

        function addCtx() { syncUItoState(); contexts.push({id:'c'+Date.now(), l:'New Tab', i:'üè∑Ô∏è'}); renderEditor(); }
        function delCtx(i) { showModal("Confirm", "Remove this tab?", () => { contexts.splice(i, 1); renderEditor(); }); }
        function addQ() { syncUItoState(); questions.push({id:'q'+Date.now(), c:[], l:'New Question?', t:'toggle', d:false, o:''}); renderEditor(); }
        function delQ(i) { showModal("Confirm", "Remove this prompt?", () => { questions.splice(i, 1); renderEditor(); }); }

        function saveConfig() {
            syncUItoState();
            localStorage.setItem('skel_ctx_v7', JSON.stringify(contexts));
            localStorage.setItem('skel_q_v7', JSON.stringify(questions));
            location.reload();
        }

        function renderCal() {
            const cont = document.getElementById('calContainer'); cont.innerHTML = '';
            const now = new Date();
            const todayStr = getLocalDay();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
            for(let i=1; i<=daysInMonth; i++) {
                const day = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                cont.innerHTML += `<div class="cal-d ${history[day]&&history[day].length?'has':''} ${day===todayStr?'today':''}" onclick="viewDay('${day}')">${i}</div>`;
            }
        }

        function viewDay(date) {
            const logs = history[date] || [];
            const detail = document.getElementById('dayDetail');
            if(!logs.length) return detail.innerHTML = `<p style="text-align:center; color:var(--sub); font-size:13px; margin-top:30px;">No logs for ${date}</p>`;
            detail.innerHTML = logs.map((l, index) => {
                const c = contexts.find(ctx => ctx.id === l.ctx);
                return `<div class="history-card"><button onclick="delLog('${date}', ${index})" style="position:absolute; top:12px; right:12px; color:var(--err); background:none; font-size:10px;">‚úï</button><div style="font-size:10px; color:var(--p); font-weight:900; margin-bottom:8px;">${(c ? c.l : l.ctx).toUpperCase()} ‚Äî ${l.time}</div><div style="border-top:1px solid var(--border); padding-top:10px;">${Object.entries(l.ans).map(([qid, val]) => {
                            const q = questions.find(qu => qu.id === qid);
                            const display = Array.isArray(val) ? val.join(', ') : (q && q.t === 'toggle' ? (val ? 'Yes' : 'No') : val);
                            return q ? `<div style="font-size:12px; margin-bottom:8px;"><b style="color:var(--sub); font-size:9px; text-transform:uppercase;">${q.l}</b><br>${display}</div>` : '';
                        }).join('')}</div></div>`;
            }).join('');
        }

        function delLog(date, idx) { showModal("Delete Entry", "Remove this record?", () => { history[date].splice(idx, 1); localStorage.setItem('skel_h_v7', JSON.stringify(history)); viewDay(date); renderCal(); }); }

        function renderHistoryList() {
            const term = document.getElementById('historySearch').value.toLowerCase();
            if(!term) { renderCal(); return; }
            const detail = document.getElementById('dayDetail');
            detail.innerHTML = ''; let found = false;
            Object.keys(history).reverse().forEach(date => {
                history[date].forEach((l, i) => {
                    const ctxName = (contexts.find(c => c.id === l.ctx)?.l || "").toLowerCase();
                    const answersStr = JSON.stringify(l.ans).toLowerCase();
                    if(ctxName.includes(term) || answersStr.includes(term) || date.includes(term)) {
                        found = true;
                        detail.innerHTML += `<div style="font-size:9px; font-weight:900; color:var(--p); margin:10px 0;">${date}</div>` + viewDayEntrySingle(date, l, i);
                    }
                });
            });
            if(!found) detail.innerHTML = `<p style="text-align:center; color:var(--sub); font-size:13px;">No matches found.</p>`;
        }

        function viewDayEntrySingle(date, l, index) {
            const c = contexts.find(ctx => ctx.id === l.ctx);
            return `<div class="history-card"><button onclick="delLog('${date}', ${index})" style="position:absolute; top:12px; right:12px; color:var(--err); background:none; font-size:10px;">‚úï</button><div style="font-size:10px; font-weight:900; margin-bottom:5px;">${(c ? c.l : l.ctx).toUpperCase()} @ ${l.time}</div><div>${Object.entries(l.ans).map(([qid, val]) => {
                const q = questions.find(qu => qu.id === qid);
                return q ? `<div style="font-size:12px;"><b style="color:var(--sub); font-size:9px;">${q.l}:</b> ${Array.isArray(val) ? val.join(', ') : val}</div>` : '';
            }).join('')}</div></div>`;
        }

        function dlDay(date) {
            const logs = history[date]; if(!logs) return;
            let txt = `SKELETON LOG ‚Äî ${date}\n========================\n\n`;
            logs.forEach(l => {
                const c = contexts.find(ctx => ctx.id === l.ctx);
                txt += `[${l.time}] ${(c ? c.l : l.ctx).toUpperCase()}\n`;
                Object.entries(l.ans).forEach(([qid, val]) => {
                    const q = questions.find(qu => qu.id === qid);
                    if(q) txt += ` - ${q.l}: ${Array.isArray(val) ? val.join(', ') : val}\n`;
                });
                txt += `\n`;
            });
            const blob = new Blob([txt], {type:'text/plain'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `skeleton_${date}.txt`; a.click();
        }

        function showModal(title, body, onConfirm) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalBody').innerText = body;
            modal.classList.remove('hidden');
            document.getElementById('modalConfirm').onclick = () => { modal.classList.add('hidden'); if(onConfirm) onConfirm(); };
            document.getElementById('modalCancel').onclick = () => modal.classList.add('hidden');
        }

        window.onload = init;
    </script>
</body>
</html>
